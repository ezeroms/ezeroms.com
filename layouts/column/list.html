{{ define "section_header" }}
    {{ $categoryNames := dict
        "music" "音楽"
        "manga-and-anime" "漫画・アニメ"
        "movies-and-dramas" "映画・ドラマ"
        "comedy" "お笑い"
        "gaming" "ゲーム"
        "sports" "スポーツ"
        "books-and-magazines" "本・雑誌"
        "politics" "政治"
        "economy-and-business" "経済・ビジネス"
        "languages" "言葉・言語"
        "foreign-cultures" "海外文化"
        "design-and-creative" "デザイン・クリエイティブ"
        "internet-and-technology" "インターネット・技術"
        "natural-science" "自然科学"
        "humanities-and-social-sciences" "人文・社会科学"
    }}
    <div class="column-header">
        <nav class="column-header__nav" id="column-category-filters">
            <button class="column-header__tab active" type="button" data-category="all">すべて</button>
            {{ $allCategories := slice }}
            {{ range .Pages }}
                {{ if .Params.subject }}
                    {{ range .Params.subject }}
                        {{ if not (in $allCategories .) }}
                            {{ $allCategories = $allCategories | append . }}
                        {{ end }}
                    {{ end }}
                {{ end }}
            {{ end }}
            {{ $sortedCategories := sort $allCategories }}
            {{ range $sortedCategories }}
                {{ $categoryName := index $categoryNames . }}
                {{ if $categoryName }}
                    <button class="column-header__tab" type="button" data-category="{{ . }}">{{ $categoryName }}</button>
                {{ end }}
            {{ end }}
        </nav>
    </div>
{{ end }}

{{ define "main" }}
    <section class="diary-main">
        <div class="diary-main__content">
            <ul class="article-container column-list" id="column-articles-list">
                {{ range .Pages }}
                    {{ $categories := slice }}
                    {{ if .Params.subject }}
                        {{ $categories = .Params.subject }}
                    {{ end }}
                    {{ $tags := slice }}
                    {{ if .Params.tags }}
                        {{ $tags = .Params.tags }}
                    {{ end }}
                    <li class="column-list-item column-item" data-categories="{{ delimit $categories " " }}" data-tags="{{ delimit $tags " " }}">
                        <a href="{{ .RelPermalink }}" class="column-card">
                            <p class="date">{{ .Date | dateFormat "Jan 2" }} · {{ .Date | dateFormat "Mon" }} · {{ .Date | dateFormat "2006" }}</p>
                            <h3 class="column-card__title">{{ .Title }}</h3>
                            {{ if .Params.tags }}
                                <div class="column-card__tags">
                                    {{ $sortedTags := sort .Params.tags }}
                                    {{ range $sortedTags }}
                                        <span class="article-tag" data-tag="{{ . }}" role="button" tabindex="0">{{ . }}</span>
                                    {{ end }}
                                </div>
                            {{ end }}
                        </a>
                    </li>
                {{ end }}
            </ul>
        </div>
    </section>

    <!-- debug-info -->
    <p class="debug-info">Template : /layouts/column/list.html</p>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const categoryFilters = document.getElementById('column-category-filters');
            const columnItems = document.querySelectorAll('.column-list-item');

            // URLパラメータを取得
            const urlParams = new URLSearchParams(window.location.search);
            const urlCategory = urlParams.get('category');
            const urlTag = urlParams.get('tag') ? decodeURIComponent(urlParams.get('tag')) : null;

            // 初期状態の決定
            let selectedCategory = urlTag ? null : (urlCategory || 'all');
            let selectedTag = urlTag || null;

            function updateURL(category, tag) {
                const params = new URLSearchParams();
                if (category && category !== 'all') {
                    params.set('category', category);
                }
                if (tag) {
                    params.set('tag', tag);
                }
                const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
                window.history.pushState({ category: category, tag: tag }, '', newURL);
            }

            function filterByCategory(category) {
                selectedCategory = category;
                selectedTag = null; // カテゴリを選択したらタグをリセット

                // アクティブ状態を更新
                const allButtons = categoryFilters.querySelectorAll('.column-header__tab[data-category]');
                allButtons.forEach(btn => {
                    if (btn.getAttribute('data-category') === category) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

                // タグのアクティブ状態をリセット
                const columnTags = document.querySelectorAll('.diary-secondary-nav .sidebar-tag');
                columnTags.forEach(tagEl => {
                    tagEl.classList.remove('active');
                });

                // 記事をフィルタリング
                columnItems.forEach(item => {
                    const itemCategories = item.getAttribute('data-categories').split(' ');
                    if (category === 'all' || itemCategories.includes(category)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });

                // URLを更新
                updateURL(category, null);
            }

            function filterByTag(tag) {
                selectedTag = tag;
                selectedCategory = null; // タグを選択したらカテゴリをリセット

                // カテゴリボタンのアクティブ状態をリセット
                const allButtons = categoryFilters.querySelectorAll('.column-header__tab[data-category]');
                allButtons.forEach(btn => {
                    btn.classList.remove('active');
                });

                // タグのアクティブ状態を更新（サイドバー）
                const columnTags = document.querySelectorAll('.diary-secondary-nav .sidebar-tag');
                columnTags.forEach(tagEl => {
                    const tagValue = tagEl.getAttribute('data-tag');
                    if (tagValue === tag) {
                        tagEl.classList.add('active');
                    } else {
                        tagEl.classList.remove('active');
                    }
                });

                // タグのアクティブ状態を更新（記事内）
                const allCardTags = document.querySelectorAll('.column-card .article-tag');
                allCardTags.forEach(tagEl => {
                    const tagValue = tagEl.getAttribute('data-tag');
                    if (tagValue === tag) {
                        tagEl.classList.add('active');
                    } else {
                        tagEl.classList.remove('active');
                    }
                });

                // 記事をフィルタリング
                columnItems.forEach(item => {
                    const tags = item.getAttribute('data-tags');
                    if (tags) {
                        const tagArray = tags.split(' ').filter(t => t.trim() !== '');
                        if (tagArray.includes(tag)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    } else {
                        item.style.display = 'none';
                    }
                });

                // URLを更新
                updateURL(null, tag);
            }

            // カテゴリボタンのクリックイベント
            categoryFilters.querySelectorAll('.column-header__tab[data-category]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    filterByCategory(category);
                });
            });

            // 初期状態の設定
            if (selectedTag) {
                filterByTag(selectedTag);
            } else if (selectedCategory) {
                filterByCategory(selectedCategory);
            }

            // ブラウザの戻る/進むボタンに対応
            window.addEventListener('popstate', function(event) {
                const params = new URLSearchParams(window.location.search);
                const category = params.get('category');
                const tag = params.get('tag');
                
                if (tag) {
                    selectedTag = decodeURIComponent(tag);
                    filterByTag(selectedTag);
                } else if (category) {
                    selectedCategory = category;
                    filterByCategory(category);
                } else {
                    selectedCategory = 'all';
                    filterByCategory('all');
                }
            });

            // カード内のタグクリックイベント（親要素へのイベント伝播を防ぐ）
            document.querySelectorAll('.column-card .article-tag').forEach(tag => {
                function handleTagSelect(event) {
                    if (event) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    const tagValue = tag.getAttribute('data-tag');
                    if (tagValue) {
                        filterByTag(tagValue);
                        window.scrollTo(0, 0);
                    }
                }

                tag.addEventListener('click', handleTagSelect);
                tag.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        handleTagSelect(e);
                    }
                });
            });
        });
    </script>
{{ end }}

{{ define "secondary" }}
    {{ partial "column_menu.html" . }}
{{ end }}

