{{ define "main" }}
    {{ partial "notification.html" . }}

    <section class="page-section">
        <div class="page-section__content">
            <div class="giants-header" id="giants-header">
                <div class="giants-header__title-wrapper">
                    <button class="giants-header__link-button" onclick="copyGiantsPageUrl()">
                        <img src="{{ "images/common/icon_link.svg" | relURL }}" alt="Copy page URL">
                    </button>
                    <h1 class="giants-header__title" id="giants-header-title">The shoulders of Giants</h1>
                </div>
                <img src="{{ "images/the-shoulders-of-giants/giant.svg" | relURL }}" alt="Giant" class="giants-header__image">
            </div>
            <ul class="article-container" id="article-container">
        {{ range (where .Site.RegularPages "Section" "shoulders-of-giants") }}
            <article class="article-item hover-effect giants-item" data-topics="{{ if .Params.topic }}{{ delimit .Params.topic " " }}{{ end }}">
                <div class="giants-item__content">
                    {{ .Content }}
                </div>
                {{ if .Params.citation_override }}
                    <div class="giants-item__citation">
                        {{ .Params.citation_override }}
                    </div>
                {{ else if and .Params.author .Params.book_title .Params.publisher .Params.published_year }}
                    <div class="giants-item__citation">
                        {{ .Params.author }}『{{ .Params.book_title }}』（{{ .Params.publisher }}、{{ .Params.published_year }}年）
                    </div>
                {{ else if and .Params.author .Params.title .Params.publisher .Params.published_year }}
                    {{/* 後方互換性のため、title もサポート */}}
                    <div class="giants-item__citation">
                        {{ .Params.author }}『{{ .Params.title }}』（{{ .Params.publisher }}、{{ .Params.published_year }}年）
                    </div>
                {{ end }}
                {{ if .Params.topic }}
                    <div class="giants-item__tags">
                        {{ $sortedTopics := sort .Params.topic }}
                        {{ range $sortedTopics }}
                            <span class="tag" data-tag="{{ . }}">{{ . }}</span>
                        {{ end }}
                    </div>
                {{ end }}
            </article>
        {{ end }}
            </ul>
        </div>
    </section>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const selectedTopic = urlParams.get('topic') ? decodeURIComponent(urlParams.get('topic')) : null;
        
        const giantsItems = document.querySelectorAll('.giants-item');
        const topicLinks = document.querySelectorAll('.layout-toc__list a');

        // 初期状態でフィルタリング
        if (selectedTopic) {
            // 初期状態でアクティブなタグを設定
            topicLinks.forEach(link => {
                if (link.getAttribute('data-topic') === selectedTopic) {
                    link.classList.add('active');
                }
            });
            // カード内のタグのアクティブ状態を設定
            const cardTags = document.querySelectorAll('.giants-item .tag');
            cardTags.forEach(tag => {
                if (tag.getAttribute('data-tag') === selectedTopic) {
                    tag.classList.add('active');
                }
            });
            // タイトルを更新
            const headerTitle = document.getElementById('giants-header-title');
            if (headerTitle) {
                headerTitle.textContent = selectedTopic;
            }
            filterByTopic(selectedTopic);
            // 初期読み込み時にクエリパラメータがある場合は先頭にスクロール
            scrollToTop();
        } else {
            // タグが選択されていない場合はランダムに並び替え
            shuffleArticles();
        }

        // タグリンクにクリックイベントを追加
        topicLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const topic = this.getAttribute('data-topic');
                filterByTopic(topic);
                // タグ選択時に先頭にスクロール
                scrollToTop();
            });
        });

        // ブラウザの戻る/進むボタンに対応
        window.addEventListener('popstate', function(event) {
            const params = new URLSearchParams(window.location.search);
            const topic = params.get('topic') ? decodeURIComponent(params.get('topic')) : null;
            
            if (topic) {
                filterByTopic(topic);
            } else {
                // タグが選択されていない場合は全表示してランダムに並び替え
                const headerTitle = document.getElementById('giants-header-title');
                if (headerTitle) {
                    headerTitle.textContent = 'The shoulders of Giants';
                }
                giantsItems.forEach(item => {
                    item.style.display = '';
                });
                shuffleArticles();
            }
            
            // ページの先頭に戻る
            scrollToTop();
        });

        function filterByTopic(topic) {
            // タグのアクティブ状態を更新
            topicLinks.forEach(link => {
                if (link.getAttribute('data-topic') === topic) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // カード内のタグのアクティブ状態を更新
            const cardTags = document.querySelectorAll('.giants-item .tag');
            cardTags.forEach(tag => {
                if (tag.getAttribute('data-tag') === topic) {
                    tag.classList.add('active');
                } else {
                    tag.classList.remove('active');
                }
            });

            // タイトルを更新
            const headerTitle = document.getElementById('giants-header-title');
            if (headerTitle) {
                headerTitle.textContent = topic;
            }

            // 記事をフィルタリング
            const visibleItems = [];
            giantsItems.forEach(item => {
                const topics = item.getAttribute('data-topics');
                if (topics && topics.includes(topic)) {
                    item.style.display = '';
                    visibleItems.push(item);
                } else {
                    item.style.display = 'none';
                }
            });

            // 表示されている記事をランダムに並び替え
            shuffleArray(visibleItems);
            const articlesList = document.getElementById('article-container');
            articlesList.innerHTML = '';
            
            // まず表示されている記事を追加
            visibleItems.forEach(function(article) {
                articlesList.appendChild(article);
            });
            
            // 次に非表示の記事を追加（順序は維持）
            giantsItems.forEach(function(item) {
                if (item.style.display === 'none') {
                    articlesList.appendChild(item);
                }
            });

            // URLを更新（日本語をそのまま含める）
            const newURL = window.location.pathname + '?topic=' + encodeURIComponent(topic);
            window.history.pushState({ topic: topic }, '', newURL);

            // ページの先頭に戻る
            scrollToTop();
        }
        
        // ページの先頭にスクロールする関数
        function scrollToTop() {
            // 複数の方法で確実にスクロール位置を先頭に戻す
            window.scrollTo({
                top: 0,
                left: 0,
                behavior: 'instant'
            });
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            
            // メインコンテンツエリアがある場合もスクロール
            const mainContent = document.querySelector('.layout-main__content');
            if (mainContent) {
                mainContent.scrollTop = 0;
            }
        }

        // カード内のタグにクリックイベントを追加
        document.addEventListener('click', function(e) {
                if (e.target.classList.contains('tag') && e.target.closest('.giants-item')) {
                e.preventDefault();
                e.stopPropagation();
                const topic = e.target.getAttribute('data-tag');
                filterByTopic(topic);
                // タグ選択時に先頭にスクロール
                scrollToTop();
            }
        });

        function showNotification() {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = 'Content copied to clipboard!';
                notification.className = 'notification show';
                setTimeout(function() {
                    notification.className = notification.className.replace(' show', '');
                }, 3000);
            }
        }

        function copyGiantsPageUrl() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(function() {
                showUrlNotification();
            }, function(err) {
                console.error('リンクの保存に失敗しました: ', err);
            });
        }

        function showUrlNotification() {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = 'リンクをコピーしました';
                notification.className = 'notification show';
                setTimeout(function() {
                    notification.className = notification.className.replace(' show', '');
                }, 3000);
            }
        }

        function shuffleArticles() {
            const articles = document.querySelectorAll('.giants-item');
            const articlesArray = Array.prototype.slice.call(articles);
            shuffleArray(articlesArray);

            const articlesList = document.getElementById('article-container');
            articlesList.innerHTML = '';

            articlesArray.forEach(function(article) {
                articlesList.appendChild(article);
            });

            // ページの先頭に戻る
            scrollToTop();
        }

        // Shuffle array function
        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }
    });
    </script>
{{ end }}

{{ define "secondary" }}
    {{ partial "keyword_menu.html" . }}
{{ end }}
