<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ if and (eq .Section "diary") .IsPage }}{{ .Date | dateFormat "Jan 2" }} · {{ .Date | dateFormat "2006" }}{{ else }}{{ .Title }}{{ end }}</title>

    <!-- コードブロックのシンタックスハイライト -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- and it's easy to individually load additional languages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script>hljs.highlightAll();</script>

    <link rel="stylesheet" href="{{ "css/main.css" | relURL }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ "images/common/favicon/favicon.ico" | relURL }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ "images/common/favicon/favicon-16x16.png" | relURL }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ "images/common/favicon/favicon-32x32.png" | relURL }}">
    <link rel="icon" type="image/png" sizes="96x96" href="{{ "images/common/favicon/favicon-96x96.png" | relURL }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ "images/common/favicon/favicon-192x192.png" | relURL }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ "images/common/favicon/apple-touch-icon.png" | relURL }}">

    <!-- Open Graph -->
    <meta property="og:title" content="{{ if and (eq .Section "diary") .IsPage }}{{ .Date | dateFormat "Jan 2" }} · {{ .Date | dateFormat "2006" }}{{ else }}{{ .Title }}{{ end }}">
    <meta property="og:description" content="{{ .Site.Params.Description }}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ .Permalink }}">
    <meta property="og:image" content="{{ .Site.BaseURL }}{{ .Site.Params.OgImage }}">
    <meta property="og:site_name" content="{{ .Site.Title }}">
    <meta property="og:locale" content="ja_JP">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ if and (eq .Section "diary") .IsPage }}{{ .Date | dateFormat "Jan 2" }} · {{ .Date | dateFormat "2006" }}{{ else }}{{ .Title }}{{ end }}">
    <meta name="twitter:description" content="{{ .Site.Params.Description }}">
    <meta name="twitter:image" content="{{ .Site.BaseURL }}{{ .Site.Params.OgImage }}">

    {{ block "head" . }}{{ end }}

</head>
<body{{ if .IsHome }} class="is-home"{{ else if eq .Section "about" }} class="is-about"{{ else if eq .Section "column" }} class="is-column"{{ else if eq .Section "work" }} class="is-work"{{ else if eq .Section "ui-design-guidebook" }} class="is-ui-design-guidebook"{{ end }}>
    <!-- オーバーレイ -->
    <div class="sidebar__overlay" id="sidebar-overlay"></div>
    
    <div class="layout-container">
        <aside class="layout-sidebar" aria-label="グローバルナビゲーション">
            {{ partial "sidebar.html" . }}
        </aside>

        <div class="layout-body">
            {{/* モバイル専用ヘッダー（タブレット/スマホのみ表示） */}}
            {{ if eq .Section "about" }}
                {{ partial "mobile-header-about.html" . }}
            {{ else if or (eq .Section "diary") (hasPrefix .RelPermalink "/diary_") }}
                {{ partial "mobile-header-date-selector.html" (dict "context" . "type" "diary") }}
            {{ else if or (eq .Section "column") (hasPrefix .RelPermalink "/column_") }}
                {{ partial "mobile-header-category.html" (dict "context" . "type" "column") }}
            {{ else if or (eq .Section "work") (hasPrefix .RelPermalink "/work_") }}
                {{ partial "mobile-header-category.html" (dict "context" . "type" "work") }}
            {{ else if eq .Section "shoulders-of-giants" }}
                {{ partial "mobile-header-giants.html" . }}
            {{ else if eq .Section "chronicle" }}
                {{ partial "mobile-header-chronicle.html" . }}
            {{ else if eq .Section "ui-design-guidebook" }}
                {{ partial "mobile-header-ui-design-guidebook.html" . }}
            {{ end }}
            
            {{ if and (ne .Section "shoulders-of-giants") (ne .Section "chronicle") }}
            <div class="layout-header">
                {{ block "section_header" . }}{{ end }}
            </div>
            {{ end }}
            <div class="layout-main{{ if .IsHome }} layout-main--centered{{ else if eq .Section "chronicle" }} layout-main--with-toc layout-main--chronicle{{ else if or (eq .Section "shoulders-of-giants") (eq .Section "about") }} layout-main--with-toc{{ else if eq .Section "ui-design-guidebook" }} layout-main--with-header-toc{{ else }} layout-main--with-tags{{ end }}">
                {{ if eq .Section "shoulders-of-giants" }}
                    {{ partial "giants-toc.html" . }}
                {{ else if eq .Section "ui-design-guidebook" }}
                    {{ partial "ui-design-guidebook-toc.html" . }}
                {{ else if eq .Section "about" }}
                    {{ partial "about-toc.html" . }}
                {{ else if eq .Section "chronicle" }}
                    {{ partial "chronicle-toc.html" . }}
                {{ end }}
                <main class="layout-main__content" id="main-content">
                    {{ block "main" . }}{{ end }}
                </main>

                {{ if and (ne .Section "ui-design-guidebook") (ne .Section "about") (ne .Section "shoulders-of-giants") (ne .Section "chronicle") (not .IsHome) (or (hasPrefix .RelPermalink "/diary_") (hasPrefix .RelPermalink "/tweet_") (hasPrefix .RelPermalink "/column_") (hasPrefix .RelPermalink "/work_") (eq .Section "column") (eq .Section "work")) }}
                <aside class="layout-tags" aria-label="セカンダリーナビゲーション">
                    {{ block "secondary" . }}{{ partial "secondary-nav.html" . }}{{ end }}
                </aside>
                {{ else if and (not .IsHome) (hasPrefix .RelPermalink "/diary_") }}
                <aside class="layout-tags" aria-label="セカンダリーナビゲーション">
                    {{ block "secondary" . }}{{ end }}
                </aside>
                {{ else }}
                {{ block "secondary" . }}{{ end }}
                {{ end }}
            </div>
        </div>
    </div>

    <!-- Google Analytics -->
    {{ partial "google_analytics.html" . }}

    <!-- External links handler -->
    <script>
        (function() {
            // DOMContentLoadedを待つ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', handleExternalLinks);
            } else {
                handleExternalLinks();
            }

            function handleExternalLinks() {
                const baseURL = '{{ .Site.BaseURL }}';
                const baseHost = baseURL ? new URL(baseURL).hostname : window.location.hostname;
                
                // 記事内のリンクを取得（.article-item内のリンク）
                const articleLinks = document.querySelectorAll('.article-item a[href]');
                
                articleLinks.forEach(function(link) {
                    const href = link.getAttribute('href');
                    
                    // hrefが空、または既にtarget属性が設定されている場合はスキップ
                    if (!href || link.hasAttribute('target')) {
                        return;
                    }
                    
                    // 相対パス、または同じホストの場合は内部リンク
                    if (href.startsWith('#') || 
                        href.startsWith('/') || 
                        href.startsWith('./') ||
                        href.startsWith('../') ||
                        (href.startsWith('http') && new URL(href, window.location.href).hostname === baseHost)) {
                        // 内部リンクはそのまま（target属性を追加しない）
                        return;
                    }
                    
                    // 外部リンクの場合
                    if (href.startsWith('http://') || href.startsWith('https://') || href.startsWith('//')) {
                        link.setAttribute('target', '_blank');
                        link.setAttribute('rel', 'noopener noreferrer');
                    }
                });
            }
        })();
    </script>

    <!-- Sidebar minimize handler -->
    <script>
        (function() {
            function initSidebarMinimize() {
                const sidebar = document.querySelector('.layout-sidebar');
                const minimizeBtn = document.getElementById('sidebar-minimize-btn');
                
                if (!sidebar || !minimizeBtn) return;
                
                // デフォルトは最大化（localStorageは使わない）
                // 初期状態を更新
                updateButtonState();
                
                // 最小化/最大化ボタンのクリックイベント
                minimizeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    sidebar.classList.toggle('is-minimized');
                    updateButtonState();
                });
                
                function updateButtonState() {
                    const isMinimized = sidebar.classList.contains('is-minimized');
                    if (isMinimized) {
                        minimizeBtn.setAttribute('aria-label', 'サイドバーを最大化');
                        minimizeBtn.setAttribute('data-tooltip', 'メニューを表示する');
                        minimizeBtn.querySelector('svg').style.transform = 'rotate(180deg)';
                    } else {
                        minimizeBtn.setAttribute('aria-label', 'サイドバーを最小化');
                        minimizeBtn.setAttribute('data-tooltip', 'メニューを非表示にする');
                        minimizeBtn.querySelector('svg').style.transform = 'rotate(0deg)';
                    }
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSidebarMinimize);
            } else {
                initSidebarMinimize();
            }
        })();
    </script>

    <!-- Sidebar hamburger menu handler (タブレット/スマホ用) -->
    <script>
        (function() {
            function initSidebarHamburger() {
                const sidebar = document.querySelector('.layout-sidebar');
                const hamburgerBtn = document.getElementById('sidebar-hamburger-btn');
                const overlay = document.getElementById('sidebar-overlay');
                
                if (!sidebar || !hamburgerBtn || !overlay) return;
                
                function openSidebar() {
                    sidebar.classList.add('is-open');
                    overlay.classList.add('is-active');
                    hamburgerBtn.setAttribute('aria-label', 'メニューを閉じる');
                    hamburgerBtn.setAttribute('aria-expanded', 'true');
                    document.body.style.overflow = 'hidden';
                }
                
                function closeSidebar() {
                    sidebar.classList.remove('is-open');
                    overlay.classList.remove('is-active');
                    hamburgerBtn.setAttribute('aria-label', 'メニューを開く');
                    hamburgerBtn.setAttribute('aria-expanded', 'false');
                    document.body.style.overflow = '';
                }
                
                function toggleSidebar() {
                    if (sidebar.classList.contains('is-open')) {
                        closeSidebar();
                    } else {
                        openSidebar();
                    }
                }
                
                // ハンバーガーボタンのクリックイベント
                hamburgerBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleSidebar();
                });
                
                // オーバーレイのクリックイベント
                overlay.addEventListener('click', function(e) {
                    e.preventDefault();
                    closeSidebar();
                });
                
                // サイドバー内のリンクをクリックしたら閉じる（タブレット/スマホのみ）
                const sidebarLinks = sidebar.querySelectorAll('a');
                sidebarLinks.forEach(function(link) {
                    link.addEventListener('click', function() {
                        if (window.innerWidth <= 1079) {
                            closeSidebar();
                        }
                    });
                });
                
                // ESCキーで閉じる
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && sidebar.classList.contains('is-open')) {
                        closeSidebar();
                    }
                });
                
                // ウィンドウリサイズ時にサイドバーを閉じる（デスクトップサイズに戻った場合）
                let resizeTimer;
                window.addEventListener('resize', function() {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(function() {
                        if (window.innerWidth > 1079) {
                            closeSidebar();
                        }
                    }, 100);
                });
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSidebarHamburger);
            } else {
                initSidebarHamburger();
            }
        })();
    </script>

    <script>
        (function() {
            // DOMContentLoadedを待つ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initHeaderScroll);
            } else {
                initHeaderScroll();
            }

            function initHeaderScroll() {
                const header = document.querySelector('.layout-header');
                if (!header) {
                    console.log('Header not found');
                    return;
                }

                // 空のheaderは処理しない
                if (header.children.length === 0) {
                    return;
                }

                let lastScrollTop = 0;
                let scrollTimeout = null;
                let isScrollingDown = false;
                let ticking = false;

                function getScrollTop() {
                    return window.pageYOffset || document.documentElement.scrollTop || 0;
                }

                function handleScroll() {
                    const scrollTop = getScrollTop();
                    
                    // スクロール位置が変わっていない場合は処理をスキップ
                    if (Math.abs(scrollTop - lastScrollTop) < 1) {
                        return;
                    }

                    const scrollingDown = scrollTop > lastScrollTop;
                    const scrollingUp = scrollTop < lastScrollTop;

                    // スクロールタイムアウトをクリア
                    if (scrollTimeout) {
                        clearTimeout(scrollTimeout);
                        scrollTimeout = null;
                    }

                    // ページトップ付近では常に表示
                    if (scrollTop <= 100) {
                        header.classList.remove('hidden');
                        isScrollingDown = false;
                        lastScrollTop = scrollTop;
                        return;
                    }

                    // 上にスクロールしたら即座に表示
                    if (scrollingUp) {
                        header.classList.remove('hidden');
                        isScrollingDown = false;
                    }
                    // 下にスクロールしたら非表示
                    else if (scrollingDown) {
                        header.classList.add('hidden');
                        isScrollingDown = true;
                    }

                    lastScrollTop = scrollTop;

                    // スクロールが止まったら3秒後に表示（下にスクロールしていた場合のみ）
                    if (isScrollingDown) {
                        scrollTimeout = setTimeout(function() {
                            header.classList.remove('hidden');
                            isScrollingDown = false;
                            scrollTimeout = null;
                        }, 3000);
                    }
                }

                // 初期スクロール位置を設定
                lastScrollTop = getScrollTop();

                // スクロールイベントを監視（throttle付き）
                window.addEventListener('scroll', function() {
                    if (!ticking) {
                        window.requestAnimationFrame(function() {
                            handleScroll();
                            ticking = false;
                        });
                        ticking = true;
                    }
                }, { passive: true });

                // 初期状態を設定
                handleScroll();
            }
        })();
    </script>

    <!-- Tag links handler -->
    <script src="{{ "js/tag-links.js" | relURL }}"></script>
    
    <!-- Lazy loading handler -->
    <script src="{{ "js/lazy-load.js" | relURL }}"></script>
</body>
</html>
