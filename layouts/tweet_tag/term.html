{{ define "section_header" }}
    {{ partial "date-selector-nav-tweet.html" . }}
{{ end }}

{{ define "main" }}
    {{ partial "notification.html" . }}

    {{ $allMonths := slice }}
    {{ range .Pages }}
        {{ $monthStr := .Date | dateFormat "2006-01" }}
        {{ if not (in $allMonths $monthStr) }}
            {{ $allMonths = $allMonths | append $monthStr }}
        {{ end }}
    {{ end }}
    {{ $sortedMonths := sort $allMonths }}
    {{ $total := len $sortedMonths }}
    {{ $latestMonth := "" }}
    {{ if gt $total 0 }}
        {{ $latestMonth = index $sortedMonths (sub $total 1) }}
    {{ end }}

    <section class="page-section">
        <div class="page-section__content">
            <ul class="article-container tweet-container" id="tweet-list">
                {{/* Tweet„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„Éö„Éº„Ç∏„ÅÆ„Åø„ÇíË°®Á§∫ */}}
                {{ range where .Pages "Section" "tweet" }}
                    <article class="article-item tweet-item">
                        <div class="tweet-item__bubble">
                            <div class="tweet-item__text{{ if .Params.voice }} tweet-item__text--{{ .Params.voice }}{{ end }}">{{ .Content }}</div>
                            <div class="tweet-item__bottom">
                                {{ if .Params.tweet_tag }}
                                    <div class="tweet-item__tags">
                                        {{ $currentTag := "" }}
                                        {{ if hasPrefix $.RelPermalink "/tweet_tag/" }}
                                            {{ $pathParts := split (trim $.RelPermalink "/") "/" }}
                                            {{ if ge (len $pathParts) 2 }}
                                                {{ $currentTag = index $pathParts 1 }}
                                            {{ end }}
                                        {{ end }}
                                        {{ $sortedTags := sort .Params.tweet_tag }}
                                        {{ range $sortedTags }}
                                            {{ $label := . }}
                                            {{ $isActive := false }}
                                            {{ if and $currentTag (eq ($label | urlize) $currentTag) }}
                                                {{ $isActive = true }}
                                            {{ end }}
                                            {{ $taxonomy := "" }}
                                            {{ range $term, $pages := $.Site.Taxonomies.tweet_tag }}
                                                {{ if eq ($term | urlize) ($label | urlize) }}
                                                    {{ $taxonomy = $pages }}
                                                {{ end }}
                                            {{ end }}
                                            {{ with $taxonomy }}
                                                <a href="{{ .Page.RelPermalink }}" class="tag {{ if $isActive }}active{{ end }}" data-tag="{{ $label }}">{{ $label }}</a>
                                            {{ else }}
                                                <span class="tag {{ if $isActive }}active{{ end }}" data-tag="{{ $label }}">{{ $label }}</span>
                                            {{ end }}
                                        {{ end }}
                                    </div>
                                {{ end }}
                                <div class="tweet-item__footer">
                                    <p class="date tweet-item__date">
                                        {{ .Date | dateFormat "Jan 2" }} ¬∑ {{ .Date | dateFormat "Mon" }} ¬∑ {{ .Date | dateFormat "2006" }}{{ if .Params.tweet_place }} ¬∑ <span class="tweet-item__place-link">{{ .Params.tweet_place }}</span>{{ end }}
                                    </p>
                                </div>
                            </div>
                            <div class="tweet-item__emoji" aria-label="{{ if .Params.voice }}{{ .Params.voice }}{{ else }}ÈÄöÂ∏∏„ÅÆÂ£∞{{ end }}">{{ if .Params.emoji }}{{ .Params.emoji }}{{ else }}üòä{{ end }}</div>
                        </div>
                    </article>
                {{ end }}
            </ul>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const yearSelector = document.querySelector('.date-selector-nav__year-selector');
            const yearDisplay = document.getElementById('year-display');
            const prevYearBtn = document.getElementById('prev-year');
            const nextYearBtn = document.getElementById('next-year');
            const monthFilters = document.getElementById('date-selector-nav__month-filters');
            
            if (!yearSelector || !yearDisplay || !prevYearBtn || !nextYearBtn || !monthFilters) {
                return;
            }
            
            let currentYear = parseInt(yearDisplay.textContent);
            const minYear = parseInt(yearSelector.getAttribute('data-min-year')) || currentYear;
            const maxYear = parseInt(yearSelector.getAttribute('data-max-year')) || currentYear;

            function updateMonthButtons(year) {
                // <a>„Çø„Ç∞„Å®<span>„Çø„Ç∞„ÅÆ‰∏°Êñπ„ÇíÂØæË±°„Å´„Åô„Çã
                const buttons = monthFilters.querySelectorAll('a, span');
                
                buttons.forEach(btn => {
                    const btnYear = btn.getAttribute('data-year');
                    if (btnYear === String(year)) {
                        // Ë°®Á§∫Âπ¥„ÅÆÂ†¥Âêà„ÅØ„ÄÅdisplay: none„ÇíÂâäÈô§Ôºà‰ªñ„ÅÆstyleÂ±ûÊÄß„ÅØ‰øùÊåÅÔºâ
                        const currentStyle = btn.getAttribute('style') || '';
                        if (currentStyle.includes('display: none')) {
                            const newStyle = currentStyle.replace(/display:\s*none;?\s*/gi, '').trim();
                            if (newStyle) {
                                btn.setAttribute('style', newStyle);
                            } else {
                                btn.removeAttribute('style');
                            }
                        }
                    } else {
                        // ÈùûË°®Á§∫Âπ¥„ÅÆÂ†¥Âêà„ÅØ„ÄÅdisplay: none„ÇíËøΩÂä†Ôºà‰ªñ„ÅÆstyleÂ±ûÊÄß„ÅØ‰øùÊåÅÔºâ
                        const currentStyle = btn.getAttribute('style') || '';
                        if (!currentStyle.includes('display: none')) {
                            const newStyle = currentStyle ? currentStyle + '; display: none' : 'display: none';
                            btn.setAttribute('style', newStyle);
                        }
                    }
                });
            }

            function updateYearButtons() {
                if (currentYear <= minYear) {
                    prevYearBtn.classList.add('disabled');
                    prevYearBtn.disabled = true;
                } else {
                    prevYearBtn.classList.remove('disabled');
                    prevYearBtn.disabled = false;
                }
                
                if (currentYear >= maxYear) {
                    nextYearBtn.classList.add('disabled');
                    nextYearBtn.disabled = true;
                } else {
                    nextYearBtn.classList.remove('disabled');
                    nextYearBtn.disabled = false;
                }
            }

            prevYearBtn.addEventListener('click', function() {
                if (currentYear > minYear) {
                    currentYear--;
                    yearDisplay.textContent = currentYear;
                    updateMonthButtons(currentYear);
                    updateYearButtons();
                }
            });

            nextYearBtn.addEventListener('click', function() {
                if (currentYear < maxYear) {
                    currentYear++;
                    yearDisplay.textContent = currentYear;
                    updateMonthButtons(currentYear);
                    updateYearButtons();
                }
            });

            // ÂàùÊúüÁä∂ÊÖã„ÅßÊúà„ÅÆ„Éú„Çø„É≥„Å®Âπ¥ÈÅ∏Êäû„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
            updateMonthButtons(currentYear);
            updateYearButtons();
        });
    </script>
{{ end }}

{{ define "secondary" }}
    {{ partial "tweet_menu.html" . }}
{{ end }}
