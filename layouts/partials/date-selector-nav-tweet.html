{{/* Tweet用：月選択ヘッダー（一覧・詳細共通） */}}
<div class="date-selector-nav">
    {{/* すべてのTweetページから存在する月を収集 */}}
    {{ $tweetSection := .Site.GetPage "section" "tweet" }}
    {{ $allMonths := slice }}
    {{ if $tweetSection }}
        {{ range $tweetSection.Pages }}
            {{ $monthStr := .Date | dateFormat "2006-01" }}
            {{ if not (in $allMonths $monthStr) }}
                {{ $allMonths = $allMonths | append $monthStr }}
            {{ end }}
        {{ end }}
    {{ end }}
    {{ $sortedMonths := sort $allMonths }}
    {{ $total := len $sortedMonths }}
    {{ $latestMonth := "" }}
    {{ if gt $total 0 }}
        {{ $latestMonth = index $sortedMonths (sub $total 1) }}
    {{ end }}

    {{/* 現在コンテキストの月（詳細ページではその記事の月、一覧では空） */}}
    {{ $currentMonth := "" }}
    {{ if .IsPage }}
        {{ $currentMonth = .Date | dateFormat "2006-01" }}
    {{ else if and .Data .Data.Term }}
        {{/* taxonomyページ等ではTermをそのまま使う */}}
        {{ $currentMonth = .Data.Term }}
    {{ end }}

    {{/* 年の範囲算出 */}}
    {{ $years := slice }}
    {{ range $sortedMonths }}
        {{ $year := index (split . "-") 0 }}
        {{ if not (in $years $year) }}
            {{ $years = $years | append $year }}
        {{ end }}
    {{ end }}
    {{ $sortedYears := sort $years }}
    {{ $minYear := 0 }}
    {{ $maxYear := 0 }}
    {{ if gt (len $sortedYears) 0 }}
        {{ $minYear = int (index $sortedYears 0) }}
        {{ $maxYear = int (index $sortedYears (sub (len $sortedYears) 1)) }}
    {{ end }}

    {{/* 表示する基準年：詳細はその記事の年、一覧は最新年 */}}
    {{ $displayYear := "" }}
    {{ if $currentMonth }}
        {{ $displayYear = index (split $currentMonth "-") 0 }}
    {{ else if $latestMonth }}
        {{ $displayYear = index (split $latestMonth "-") 0 }}
    {{ end }}
    {{ if not $displayYear }}
        {{ $displayYear = "2025" }}
    {{ end }}

    <div class="date-selector-nav__year-selector">
        <button class="date-selector-nav__year-nav" id="prev-year">‹</button>
        <span class="date-selector-nav__year-display" id="year-display">{{ $displayYear }}</span>
        <button class="date-selector-nav__year-nav" id="next-year">›</button>
    </div>

    <div class="date-selector-nav__month-filters" id="date-selector-nav__month-filters">
        {{ $months := slice "J" "F" "M" "A" "M" "J" "J" "A" "S" "O" "N" "D" }}
        {{ $allYearMonths := slice }}
        {{ range $sortedMonths }}
            {{ if hasPrefix . (printf "%s-" $displayYear) }}
                {{ $allYearMonths = $allYearMonths | append . }}
            {{ end }}
        {{ end }}

        {{ range $index, $label := $months }}
            {{ $monthNum := printf "%02d" (add $index 1) }}
            {{ $yearMonth := printf "%s-%s" $displayYear $monthNum }}
            {{ $hasTweets := in $allYearMonths $yearMonth }}

            {{ $isActive := false }}
            {{ if $currentMonth }}
                {{ if eq $yearMonth $currentMonth }}
                    {{ $isActive = true }}
                {{ end }}
            {{ else if and (not $currentMonth) (eq $yearMonth $latestMonth) }}
                {{ $isActive = true }}
            {{ end }}

            {{ $monthPage := index $.Site.Taxonomies.tweet_month ($yearMonth | urlize) }}
            {{ if $monthPage }}
                <a
                    href="{{ $monthPage.Page.RelPermalink }}"
                    class="date-selector-nav__filter-btn {{ if $isActive }}active{{ end }}"
                    data-year-month="{{ $yearMonth }}"
                    data-year="{{ $displayYear }}"
                    {{ if not $hasTweets }}style="opacity: 0.4; cursor: not-allowed; pointer-events: none;"{{ end }}
                >{{ $label }}</a>
            {{ else }}
                <span
                    class="date-selector-nav__filter-btn {{ if $isActive }}active{{ end }}"
                    data-year-month="{{ $yearMonth }}"
                    data-year="{{ $displayYear }}"
                    {{ if not $hasTweets }}style="opacity: 0.4; cursor: not-allowed; pointer-events: none;"{{ end }}
                >{{ $label }}</span>
            {{ end }}
        {{ end }}
    </div>
</div>

