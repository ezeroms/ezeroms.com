<!doctype html><html lang=en><head><meta charset=UTF-8><title>MattermostのWebSocket接続エラーを解決した</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js></script><script>hljs.highlightAll()</script><link rel=stylesheet href=/css/main.css><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/x-icon href=/images/common/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/images/common/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/images/common/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/images/common/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=192x192 href=/images/common/favicon/favicon-192x192.png><link rel=apple-touch-icon sizes=180x180 href=/images/common/favicon/apple-touch-icon.png><meta property="og:title" content="MattermostのWebSocket接続エラーを解決した"><meta property="og:description" content="One thing I can tell you is you got to be free!"><meta property="og:type" content="website"><meta property="og:url" content="https://ezeroms.com/column/mattermost-websocket-error/"><meta property="og:image" content="https://ezeroms.com/images/common/og-image.png"><meta property="og:site_name" content="ezeroms.com"><meta property="og:locale" content="ja_JP"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="MattermostのWebSocket接続エラーを解決した"><meta name=twitter:description content="One thing I can tell you is you got to be free!"><meta name=twitter:image content="https://ezeroms.com/images/common/og-image.png"></head><body class=is-column><div class=layout-container><aside class=layout-sidebar aria-label=グローバルナビゲーション><div class=sidebar><div class=sidebar__main><div class=sidebar__logo><a href=/><img src=/images/common/logo.svg alt=ezeroms.com>
</a><button class=sidebar__minimize-btn id=sidebar-minimize-btn aria-label=サイドバーを最小化 data-tooltip=メニューを非表示にする>
<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M10 12 6 8l4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div><nav class=sidebar__nav-group aria-label=グローバルナビゲーション><ul class=sidebar__nav><li><a href=/about/>About</a></li><li><a href=/tweet/>Tweet</a></li><li><a href=/diary/>Diary</a></li><li><a class=is-active href=/column/>Column</a></li><li><a href=/work/>Work</a></li></ul><div class=sidebar__library><h3 class=sidebar__library-heading>Library</h3><ul class=sidebar__nav><li><a href=/shoulders-of-giants/>The shoulders of Giants</a></li><li><a href=/chronicle/>Chronicle</a></li><li><a href=/ui-design-guidebook/>UI Design Guidebook</a></li></ul></div></nav></div></div></aside><div class=layout-body><div class=layout-header><div class=column-header><nav class=column-header__nav><button class=column-header__tab data-category=all>すべて</button>
<a class=column-header__tab href="/column/?category=books-and-magazines">本・雑誌</a>
<a class=column-header__tab href="/column/?category=design-and-creative">デザイン・クリエイティブ</a>
<a class=column-header__tab href="/column/?category=foreign-cultures">海外文化</a>
<a class=column-header__tab href="/column/?category=humanities-and-social-sciences">人文・社会科学</a>
<a class="column-header__tab active" href="/column/?category=internet-and-technology">インターネット・技術</a>
<a class=column-header__tab href="/column/?category=manga-and-anime">漫画・アニメ</a>
<a class=column-header__tab href="/column/?category=movies-and-dramas">映画・ドラマ</a>
<a class=column-header__tab href="/column/?category=natural-science">自然科学</a></nav></div></div><div class="layout-main layout-main--with-tags"><main class=layout-main__content id=main-content><div id=notification class=notification>Link copied to clipboard!</div><section class=diary-main><div class=diary-main__content><ul class=article-container><article class=article-item><div class=article-header><p class=date>Column · May 29 · Thu · 2025</p><h1>MattermostのWebSocket接続エラーを解決した</h1><div class=column-card__tags><a href="/column/?tag=mattermost" class=article-tag data-tag=Mattermost>Mattermost</a>
<a href="/column/?tag=%25E6%258A%2580%25E8%25A1%2593" class=article-tag data-tag=技術>技術</a></div></div><p>MattermostにBoards（旧・Focalboard）のプラグインを入れる作業をする過程で発生したエラーに関する備忘録。</p><ul><li><a href=https://developers.mattermost.com/contribute/more-info/focalboard/mattermost-boards-setup-guide/>Mattermost Boards plugin guide</a></li><li><a href=https://www.focalboard.com/>Focalboard</a></li></ul><h6 id=heading>﻿</h6><p>プラグインをインストールしてBoardsのUIが表示されたまではよかったのだが、その画面上部に次のようなエラーが表示された。</p><div class=image-wrapper><img src=/images/diary/mattermost-websocket-error/tuv46xwmkyhxblz1cscp.png alt></div><blockquote><p>WebSocket connection closed, connection interrupted.<br>If this persists, check your server or web proxy configuration.</p></blockquote><p>チャンネル（プロジェクト）やタスクをクリックしても何も起きない。タスクの新規作成はできるが編集はできないなど、部分的にできることできないことがあり、明らかに壊れている様子でもある。いろいろと検証した結果、これは「Boardsのインターフェースは立ち上がっているが、WebSocket通信が失敗していて機能していない状態」だろうということが分かった。以下に対処方法を記録しておく。</p><h2 id=原因その1nginxの設定ミス>原因その1：NGINXの設定ミス</h2><p>まず、リバースプロキシとして動作しているNginxの設定がどのようになっているかを確認する。</p><p>※ Mattermostはデフォルトではポート8065番で動作しているが、それを <a href=https://chat.chooning.app>https://chat.chooning.app</a> のような独自ドメインで扱うには、外部からのリクエストをNginxで受け取り、Mattermost本体に転送する必要がある（＝リバースプロキシ）。</p><h6 id=heading-1>　﻿</h6><p>その設定が有効になっているかを確認するため、有効なサイト設定ファイルの一覧を表示。</p><pre tabindex=0><code>ls -l /etc/nginx/sites-enabled/
</code></pre><p><code>/etc/nginx/sites-enabled/</code>  は、Nginxが読み込むサイト設定ファイルへのシンボリックリンクが置かれている場所。 <code>/etc/nginx/sites-available/</code> にある設定ファイルのうち、実際に有効にしたいものをシンボリックリンクとして <code>/etc/nginx/sites-enabled/</code> に格納することで、設定が反映されるようになる。</p><ul><li><code>/etc/nginx/sites-available/</code> ： すべてのNginx用の設定ファイルの本体を置いておく場所。まだ有効にはなっていない。</li><li><code>/etc/nginx/sites-enabled/</code> ：実際にNginxが読み込んで使う設定ファイルのシンボリックリンクを置く場所。ここにあるファイルだけが、Nginx起動時に読み込まれて反映される。</li></ul><h6 id=heading-2>　﻿</h6><p>実行結果。<code>mattermost</code> という名前の設定ファイルが <code>/etc/nginx/sites-available/mattermost</code>  からリンクされていることから、Mattermost用のNginx設定が有効になっていることが確認できる。</p><pre tabindex=0><code>default -&gt; /etc/nginx/sites-available/default
mattermost -&gt; /etc/nginx/sites-available/mattermost
</code></pre><h6 id=heading-3>　﻿</h6><p>本体の設定ファイルの中身を確認。</p><pre tabindex=0><code>cat /etc/nginx/sites-available/mattermost
</code></pre><pre tabindex=0><code>server {
    server_name chat.chooning.app;

    location / {
        proxy_pass http://localhost:8065;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/chat.chooning.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chat.chooning.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
</code></pre><p>設定ファイルの中に、HTTPからWebSocketへプロトコルをアップグレードする際に必要なヘッダー項目が抜けていることが分かる。これがないとWebSocket接続が確立できない。</p><h6 id=heading-4>　﻿</h6><p>修正</p><pre tabindex=0><code>server {
    server_name chat.chooning.app;

    location / {
        proxy_pass http://localhost:8065;
        proxy_http_version 1.1;                           # これを追加
        proxy_set_header Upgrade $http_upgrade;           # これを追加
        proxy_set_header Connection &#34;upgrade&#34;;            # これを追加
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/chat.chooning.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chat.chooning.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
</code></pre><h6 id=heading-5>　﻿</h6><p>Nginxを再読み込み</p><pre tabindex=0><code># 文法チェック
sudo nginx -t

# 成功したらNginxを再起動
sudo systemctl reload nginx
</code></pre><h2 id=原因その2configjsonの設定ミス>原因その2：config.jsonの設定ミス</h2><p>Nginxの設定を修正したことで「WebSocket connection closed, connection interrupted.」のエラーは解消されたものの、BoardsのUIが動かない現象は解決しなかった。</p><h6 id=heading-6>　﻿</h6><p>Dockerコンテナ内に入って、config.json（Mattermost本体の設定ファイル）の内容を確認する。</p><pre tabindex=0><code>sudo docker exec -it mattermost_app_1 /bin/bash
cat /mattermost/config/config.json | grep -A 10 ServiceSettings
</code></pre><h6 id=heading-7>　﻿</h6><p>その結果、SiteURLとWebsocketURLが空であることが判明。この2つの値はMattermostが自身のURLやWebSocket接続先を認識するために必要なもので、ここが空だと接続が正しく行えない。</p><pre tabindex=0><code>&#34;SiteURL&#34;: &#34;&#34;,
&#34;WebsocketURL&#34;: &#34;&#34;,
</code></pre><h6 id=heading-8>　﻿</h6><p>修正</p><pre tabindex=0><code>sed -i &#39;s|&#34;SiteURL&#34;: &#34;&#34;|&#34;SiteURL&#34;: &#34;https://chat.chooning.app&#34;|&#39; /mattermost/config/config.json
sed -i &#39;s|&#34;WebsocketURL&#34;: &#34;&#34;|&#34;WebsocketURL&#34;: &#34;wss://chat.chooning.app&#34;|&#39; /mattermost/config/config.json
</code></pre><h6 id=heading-9>　﻿</h6><p>コンテナから出て、コンテナ再起動</p><pre tabindex=0><code>exit
sudo docker restart mattermost_app_1
</code></pre><h6 id=heading-10>　﻿</h6><p>上記2つの修正を行ったことで、Boardが正常に使えるようになった＼(^o^)／</p><h2 id=副作用的に他のエラーthe-server-is-not-reachableも解決した>副作用的に他のエラー（「The server is not reachable.」）も解決した</h2><p>実はずっとネイティブアプリに「The server is not reachable.」というエラーが表示されていたのだが、WebSocket接続エラーを解決したことで偶然これも解決した。</p><div class=image-wrapper><img src=/images/diary/mattermost-websocket-error/5r1nil9wlarcbjgvu2dth6.png alt></div><p>この通知、初期セットアップ時からずっと表示されていたのだが、Mattermost自体は普通に使えており、<a href=https://forum.mattermost.com/t/intermittent-the-server-is-not-reachable-for-some-users-on-mobile/16884/6>フォーラムにも同様の報告が上がっていた</a>ので、まあネイティブアプリのバグかなと思って放置していた。しかし実際にはWebSocket接続が失敗していたために表示されていたっぽい／(^o^)＼</p><p>アプリがある程度は動いていたのは、WebSocketを使わない基本的なAPI通信が問題なく通っていたからではないかと思う。（通知やBoardsなどのリアルタイムUIは動かないが、通常の投稿やチャンネル閲覧などはHTTP通信だけで動作していた、ということなんじゃないかと思う。たぶん……）</p><h6 id=heading-11>　﻿</h6><p>何はともあれ、これでBoardsが使えるようになった。Slack的なコミュニケーションとNotion的なやつが同一アプリ内で使えるの快適すぐる！！！！！</p><div class=image-wrapper><img src=/images/diary/mattermost-websocket-error/bpgrweqlqm2x7pwvqlxy.png alt></div><h6 id=heading-12>　﻿</h6><p>Boardのセットアップに関する記事はこの土日に書く。この一週間ですっかりMattermostの虜や〜〜〜</p></article><div class=article-navigation><div class=article-navigation__prev><a href=/column/hugo-section-page-not-rendering/ class=article-navigation__link><span class=article-navigation__icon>←</span><div class=article-navigation__content><span class=article-navigation__label>Prev</span>
<span class=article-navigation__title>Hugo v0.125以降で _index.md を使ったセクションページが表示されなくなった件</span></div></a></div><div class=article-navigation__next><a href=/column/6xgc8ozluvuxhgwcf68yb9/ class=article-navigation__link><span class=article-navigation__icon>→</span><div class=article-navigation__content><span class=article-navigation__label>Next</span>
<span class=article-navigation__title>Hugo + Netlify の静的ブログに Contentful で管理画面を取り付けた</span></div></a></div><div class=article-navigation__back><a href=/column/ class=article-navigation__link><span class=article-navigation__label>記事一覧に戻る</span></a></div></div></ul></div></section><script>document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".article-item .article-tag").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("data-tag");t&&(window.location.href="/column/?tag="+encodeURIComponent(t))})})})</script></main><aside class=layout-tags aria-label=セカンダリーナビゲーション><div class=diary-secondary-nav><div class=diary-secondary-nav__section><p class=diary-secondary-nav__heading>Tags</p><div class=tweet-secondary-nav__tags><a href="/column/?tag=ai" class=sidebar-tag data-tag=AI data-tag-urlized=ai>AI</a>
<a href="/column/?tag=contentful" class=sidebar-tag data-tag=Contentful data-tag-urlized=contentful>Contentful</a>
<a href="/column/?tag=hugo" class=sidebar-tag data-tag=Hugo data-tag-urlized=hugo>Hugo</a>
<a href="/column/?tag=mattermost" class=sidebar-tag data-tag=Mattermost data-tag-urlized=mattermost>Mattermost</a>
<a href="/column/?tag=neobrutalism" class=sidebar-tag data-tag=Neobrutalism data-tag-urlized=neobrutalism>Neobrutalism</a>
<a href="/column/?tag=netlify" class=sidebar-tag data-tag=Netlify data-tag-urlized=netlify>Netlify</a>
<a href="/column/?tag=sns" class=sidebar-tag data-tag=SNS data-tag-urlized=sns>SNS</a>
<a href="/column/?tag=tinder" class=sidebar-tag data-tag=Tinder data-tag-urlized=tinder>Tinder</a>
<a href="/column/?tag=web%25E3%2582%25B5%25E3%2582%25A4%25E3%2583%2588" class=sidebar-tag data-tag=Webサイト data-tag-urlized=web%E3%82%B5%E3%82%A4%E3%83%88>Webサイト</a>
<a href="/column/?tag=%25E3%2582%25A2%25E3%2583%258B%25E3%2583%25A1" class=sidebar-tag data-tag=アニメ data-tag-urlized=%E3%82%A2%E3%83%8B%E3%83%A1>アニメ</a>
<a href="/column/?tag=%25E3%2582%25BF%25E3%2582%25A4%25E3%2583%259D%25E3%2582%25B0%25E3%2583%25A9%25E3%2583%2595%25E3%2582%25A3" class=sidebar-tag data-tag=タイポグラフィ data-tag-urlized=%E3%82%BF%E3%82%A4%E3%83%9D%E3%82%B0%E3%83%A9%E3%83%95%E3%82%A3>タイポグラフィ</a>
<a href="/column/?tag=%25E3%2583%2587%25E3%2582%25B6%25E3%2582%25A4%25E3%2583%25B3" class=sidebar-tag data-tag=デザイン data-tag-urlized=%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3>デザイン</a>
<a href="/column/?tag=%25E3%2583%2586%25E3%2582%25B9%25E3%2583%2588" class=sidebar-tag data-tag=テスト data-tag-urlized=%E3%83%86%E3%82%B9%E3%83%88>テスト</a>
<a href="/column/?tag=%25E3%2583%258B%25E3%2583%25A5%25E3%2583%25BC%25E3%2582%25B9" class=sidebar-tag data-tag=ニュース data-tag-urlized=%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%B9>ニュース</a>
<a href="/column/?tag=%25E3%2583%2597%25E3%2583%25AD%25E3%2583%2580%25E3%2582%25AF%25E3%2583%2588%25E9%2596%258B%25E7%2599%25BA" class=sidebar-tag data-tag=プロダクト開発 data-tag-urlized=%E3%83%97%E3%83%AD%E3%83%80%E3%82%AF%E3%83%88%E9%96%8B%E7%99%BA>プロダクト開発</a>
<a href="/column/?tag=%25E3%2583%259D%25E3%2583%2583%25E3%2583%2589%25E3%2582%25AD%25E3%2583%25A3%25E3%2582%25B9%25E3%2583%2588" class=sidebar-tag data-tag=ポッドキャスト data-tag-urlized=%E3%83%9D%E3%83%83%E3%83%89%E3%82%AD%E3%83%A3%E3%82%B9%E3%83%88>ポッドキャスト</a>
<a href="/column/?tag=%25E3%2583%259E%25E3%2583%25B3%25E3%2582%25AC" class=sidebar-tag data-tag=マンガ data-tag-urlized=%E3%83%9E%E3%83%B3%E3%82%AC>マンガ</a>
<a href="/column/?tag=%25E5%258F%25B0%25E6%25B9%25BE" class=sidebar-tag data-tag=台湾 data-tag-urlized=%E5%8F%B0%E6%B9%BE>台湾</a>
<a href="/column/?tag=%25E6%258A%2580%25E8%25A1%2593" class=sidebar-tag data-tag=技術 data-tag-urlized=%E6%8A%80%E8%A1%93>技術</a>
<a href="/column/?tag=%25E6%2595%25A3%25E6%25AD%25A9" class=sidebar-tag data-tag=散歩 data-tag-urlized=%E6%95%A3%E6%AD%A9>散歩</a>
<a href="/column/?tag=%25E6%2596%2587%25E5%258C%2596" class=sidebar-tag data-tag=文化 data-tag-urlized=%E6%96%87%E5%8C%96>文化</a>
<a href="/column/?tag=%25E6%2598%2586%25E8%2599%25AB%25E9%25A3%259F" class=sidebar-tag data-tag=昆虫食 data-tag-urlized=%E6%98%86%E8%99%AB%E9%A3%9F>昆虫食</a>
<a href="/column/?tag=%25E6%2598%25A0%25E7%2594%25BB" class=sidebar-tag data-tag=映画 data-tag-urlized=%E6%98%A0%E7%94%BB>映画</a>
<a href="/column/?tag=%25E6%259B%25B8%25E7%25B1%258D" class=sidebar-tag data-tag=書籍 data-tag-urlized=%E6%9B%B8%E7%B1%8D>書籍</a>
<a href="/column/?tag=%25E6%259C%25AC" class=sidebar-tag data-tag=本 data-tag-urlized=%E6%9C%AC>本</a>
<a href="/column/?tag=%25E6%25BF%25B1%25E5%258F%25A3%25E7%25AB%259C%25E4%25BB%258B" class=sidebar-tag data-tag=濱口竜介 data-tag-urlized=%E6%BF%B1%E5%8F%A3%E7%AB%9C%E4%BB%8B>濱口竜介</a></div></div></div></aside></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-K021MTL6NX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-K021MTL6NX")</script><script>(function(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e();function e(){const e="https://ezeroms.com/",t=e?new URL(e).hostname:window.location.hostname,n=document.querySelectorAll(".article-item a[href]");n.forEach(function(e){const n=e.getAttribute("href");if(!n||e.hasAttribute("target"))return;if(n.startsWith("#")||n.startsWith("/")||n.startsWith("./")||n.startsWith("../")||n.startsWith("http")&&new URL(n,window.location.href).hostname===t)return;(n.startsWith("http://")||n.startsWith("https://")||n.startsWith("//"))&&(e.setAttribute("target","_blank"),e.setAttribute("rel","noopener noreferrer"))})}})()</script><script>(function(){function e(){const t=document.querySelector(".layout-sidebar"),e=document.getElementById("sidebar-minimize-btn");if(!t||!e)return;n(),e.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),t.classList.toggle("is-minimized"),n()});function n(){const n=t.classList.contains("is-minimized");n?(e.setAttribute("aria-label","サイドバーを最大化"),e.setAttribute("data-tooltip","メニューを表示する"),e.querySelector("svg").style.transform="rotate(180deg)"):(e.setAttribute("aria-label","サイドバーを最小化"),e.setAttribute("data-tooltip","メニューを非表示にする"),e.querySelector("svg").style.transform="rotate(0deg)")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e()})()</script><script>(function(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e();function e(){const e=document.querySelector(".layout-header");if(!e){console.log("Header not found");return}if(e.children.length===0)return;let t=0,n=null,s=!1,o=!1;function i(){return window.pageYOffset||document.documentElement.scrollTop||0}function a(){const o=i();if(Math.abs(o-t)<1)return;const a=o>t,r=o<t;if(n&&(clearTimeout(n),n=null),o<=100){e.classList.remove("hidden"),s=!1,t=o;return}r?(e.classList.remove("hidden"),s=!1):a&&(e.classList.add("hidden"),s=!0),t=o,s&&(n=setTimeout(function(){e.classList.remove("hidden"),s=!1,n=null},3e3))}t=i(),window.addEventListener("scroll",function(){o||(window.requestAnimationFrame(function(){a(),o=!1}),o=!0)},{passive:!0}),a()}})()</script></body></html>