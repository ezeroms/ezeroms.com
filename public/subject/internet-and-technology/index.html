<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <title>Internet-and-Technology</title>

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script>hljs.highlightAll();</script>

    <link rel="stylesheet" href="/css/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" type="image/x-icon" href="/images/common/favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/common/favicon/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/common/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/common/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/common/favicon/favicon-192x192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/common/favicon/apple-touch-icon.png">

    
    <meta property="og:title" content="Internet-and-Technology">
    <meta property="og:description" content="One thing I can tell you is you got to be free!">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://localhost:1313/subject/internet-and-technology/">
    <meta property="og:image" content="http://localhost:1313/images/common/og-image.png">
    <meta property="og:site_name" content="ezeroms.com">
    <meta property="og:locale" content="ja_JP">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Internet-and-Technology">
    <meta name="twitter:description" content="One thing I can tell you is you got to be free!">
    <meta name="twitter:image" content="http://localhost:1313/images/common/og-image.png">

</head>
<body>
    <div class="layout-container">
        <aside class="layout-sidebar" aria-label="グローバルナビゲーション">
            <div class="sidebar">
  <div class="sidebar__main">
    <div class="sidebar__logo">
      <a href="/">
        <img src="/images/common/logo.svg" alt="ezeroms.com">
      </a>
      <button class="sidebar__minimize-btn" id="sidebar-minimize-btn" aria-label="サイドバーを最小化" data-tooltip="メニューを非表示にする">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    
    <nav class="sidebar__nav-group" aria-label="グローバルナビゲーション">
      <ul class="sidebar__nav">
        <li>
          <a class="" href="/about/">About</a>
        </li>
        <li>
          <a class="" href="/tweet/">Tweet</a>
        </li>
        <li>
          <a class="" href="/diary/">Diary</a>
        </li>
        <li>
          <a class="" href="/column/">Column</a>
        </li>
        <li>
          <a class="" href="/work/">Work</a>
        </li>
        
      </ul>
      
      <div class="sidebar__library">
        <h3 class="sidebar__library-heading">Library</h3>
        <ul class="sidebar__nav">
          <li>
            <a class="" href="/shoulders-of-giants/">The shoulders of Giants</a>
          </li>
          <li>
            <a class="" href="/chronicle/">Chronicle</a>
          </li>
          <li>
            <a class="" href="/ui-design-guidebook/">UI Design Guidebook</a>
          </li>
        </ul>
      </div>
    </nav>
  </div>
</div>


        </aside>

        <div class="layout-body">
            
            <div class="layout-header">
                
            </div>
            
            <div class="layout-main layout-main--with-tags">
                
                <main class="layout-main__content" id="main-content">
                    
    <div id="notification" class="notification">
    Link copied to clipboard!
</div>

    <section class="diary-main">
        <div class="diary-main__content">
            <ul class="article-container" id="article-container">

            <div class="article-item-heading">
                <div class="article-item-heading__label">
                    <p class="article-item-heading__label__p">
                        
                         Diary
                    </p>

                    
                    
                    
                        
                    
                    
                    
                    
                    
                    <h2 class="article-item-heading__label__h2">
                        インターネット・技術
                    </h2>
                </div>

                
                <button class="article-item-heading__button" onclick="copyToClipboard()">
                    <img src="/images/common/icon_link.svg" alt="Get article url">
                </button>
                <script>
                    function copyToClipboard() {
                        const url = window.location.href;
                        navigator.clipboard.writeText(url).then(function() {
                            showNotification();
                        }, function(err) {
                            console.error('リンクの保存に失敗しました: ', err);
                        });
                    }
                    function showNotification() {
                        var notification = document.getElementById("notification");
                        notification.className = "notification show";
                        setTimeout(function() {
                            notification.className = notification.className.replace(" show", "");
                        }, 3000);
                    }
                </script>
                        
            </div>

            
            
                
                    <article id="mattermost%E3%81%AEwebsocket%E6%8E%A5%E7%B6%9A%E3%82%A8%E3%83%A9%E3%83%BC%E3%82%92%E8%A7%A3%E6%B1%BA%E3%81%97%E3%81%9F" class="article-item">
                        <p class="date">2025-05-29</p>
                        <a href="http://localhost:1313/column/mattermost-websocket-error/">
                            <h1>MattermostのWebSocket接続エラーを解決した</h1>
                        </a>
                        
                        <p>MattermostにBoards（旧・Focalboard）のプラグインを入れる作業をする過程で発生したエラーに関する備忘録。</p>
<ul>
<li><a href="https://developers.mattermost.com/contribute/more-info/focalboard/mattermost-boards-setup-guide/">Mattermost Boards plugin guide</a></li>
<li><a href="https://www.focalboard.com/">Focalboard</a></li>
</ul>
<h6 id="heading">﻿</h6>
<p>プラグインをインストールしてBoardsのUIが表示されたまではよかったのだが、その画面上部に次のようなエラーが表示された。</p>
<div class="image-wrapper"><img src="/images/diary/mattermost-websocket-error/tuv46xwmkyhxblz1cscp.png" alt=""></div><blockquote>
<p>WebSocket connection closed, connection interrupted.<br>
If this persists, check your server or web proxy configuration.</p></blockquote>
<p>チャンネル（プロジェクト）やタスクをクリックしても何も起きない。タスクの新規作成はできるが編集はできないなど、部分的にできることできないことがあり、明らかに壊れている様子でもある。いろいろと検証した結果、これは「Boardsのインターフェースは立ち上がっているが、WebSocket通信が失敗していて機能していない状態」だろうということが分かった。以下に対処方法を記録しておく。</p>
<h2 id="原因その1nginxの設定ミス">原因その1：NGINXの設定ミス</h2>
<p>まず、リバースプロキシとして動作しているNginxの設定がどのようになっているかを確認する。</p>
<p>※ Mattermostはデフォルトではポート8065番で動作しているが、それを <a href="https://chat.chooning.app">https://chat.chooning.app</a> のような独自ドメインで扱うには、外部からのリクエストをNginxで受け取り、Mattermost本体に転送する必要がある（＝リバースプロキシ）。</p>
<h6 id="heading-1">　﻿</h6>
<p>その設定が有効になっているかを確認するため、有効なサイト設定ファイルの一覧を表示。</p>
<pre tabindex="0"><code>ls -l /etc/nginx/sites-enabled/
</code></pre><p><code>/etc/nginx/sites-enabled/</code>  は、Nginxが読み込むサイト設定ファイルへのシンボリックリンクが置かれている場所。 <code>/etc/nginx/sites-available/</code> にある設定ファイルのうち、実際に有効にしたいものをシンボリックリンクとして <code>/etc/nginx/sites-enabled/</code> に格納することで、設定が反映されるようになる。</p>
<ul>
<li><code>/etc/nginx/sites-available/</code> ： すべてのNginx用の設定ファイルの本体を置いておく場所。まだ有効にはなっていない。</li>
<li><code>/etc/nginx/sites-enabled/</code> ：実際にNginxが読み込んで使う設定ファイルのシンボリックリンクを置く場所。ここにあるファイルだけが、Nginx起動時に読み込まれて反映される。</li>
</ul>
<h6 id="heading-2">　﻿</h6>
<p>実行結果。<code>mattermost</code> という名前の設定ファイルが <code>/etc/nginx/sites-available/mattermost</code>  からリンクされていることから、Mattermost用のNginx設定が有効になっていることが確認できる。</p>
<pre tabindex="0"><code>default -&gt; /etc/nginx/sites-available/default
mattermost -&gt; /etc/nginx/sites-available/mattermost
</code></pre><h6 id="heading-3">　﻿</h6>
<p>本体の設定ファイルの中身を確認。</p>
<pre tabindex="0"><code>cat /etc/nginx/sites-available/mattermost
</code></pre><pre tabindex="0"><code>server {
    server_name chat.chooning.app;

    location / {
        proxy_pass http://localhost:8065;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/chat.chooning.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chat.chooning.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
</code></pre><p>設定ファイルの中に、HTTPからWebSocketへプロトコルをアップグレードする際に必要なヘッダー項目が抜けていることが分かる。これがないとWebSocket接続が確立できない。</p>
<h6 id="heading-4">　﻿</h6>
<p>修正</p>
<pre tabindex="0"><code>server {
    server_name chat.chooning.app;

    location / {
        proxy_pass http://localhost:8065;
        proxy_http_version 1.1;                           # これを追加
        proxy_set_header Upgrade $http_upgrade;           # これを追加
        proxy_set_header Connection &#34;upgrade&#34;;            # これを追加
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/chat.chooning.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chat.chooning.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
</code></pre><h6 id="heading-5">　﻿</h6>
<p>Nginxを再読み込み</p>
<pre tabindex="0"><code># 文法チェック
sudo nginx -t

# 成功したらNginxを再起動
sudo systemctl reload nginx
</code></pre><h2 id="原因その2configjsonの設定ミス">原因その2：config.jsonの設定ミス</h2>
<p>Nginxの設定を修正したことで「WebSocket connection closed, connection interrupted.」のエラーは解消されたものの、BoardsのUIが動かない現象は解決しなかった。</p>
<h6 id="heading-6">　﻿</h6>
<p>Dockerコンテナ内に入って、config.json（Mattermost本体の設定ファイル）の内容を確認する。</p>
<pre tabindex="0"><code>sudo docker exec -it mattermost_app_1 /bin/bash
cat /mattermost/config/config.json | grep -A 10 ServiceSettings
</code></pre><h6 id="heading-7">　﻿</h6>
<p>その結果、SiteURLとWebsocketURLが空であることが判明。この2つの値はMattermostが自身のURLやWebSocket接続先を認識するために必要なもので、ここが空だと接続が正しく行えない。</p>
<pre tabindex="0"><code>&#34;SiteURL&#34;: &#34;&#34;,
&#34;WebsocketURL&#34;: &#34;&#34;,
</code></pre><h6 id="heading-8">　﻿</h6>
<p>修正</p>
<pre tabindex="0"><code>sed -i &#39;s|&#34;SiteURL&#34;: &#34;&#34;|&#34;SiteURL&#34;: &#34;https://chat.chooning.app&#34;|&#39; /mattermost/config/config.json
sed -i &#39;s|&#34;WebsocketURL&#34;: &#34;&#34;|&#34;WebsocketURL&#34;: &#34;wss://chat.chooning.app&#34;|&#39; /mattermost/config/config.json
</code></pre><h6 id="heading-9">　﻿</h6>
<p>コンテナから出て、コンテナ再起動</p>
<pre tabindex="0"><code>exit
sudo docker restart mattermost_app_1
</code></pre><h6 id="heading-10">　﻿</h6>
<p>上記2つの修正を行ったことで、Boardが正常に使えるようになった＼(^o^)／</p>
<h2 id="副作用的に他のエラーthe-server-is-not-reachableも解決した">副作用的に他のエラー（「The server is not reachable.」）も解決した</h2>
<p>実はずっとネイティブアプリに「The server is not reachable.」というエラーが表示されていたのだが、WebSocket接続エラーを解決したことで偶然これも解決した。</p>
<div class="image-wrapper"><img src="/images/diary/mattermost-websocket-error/5r1nil9wlarcbjgvu2dth6.png" alt=""></div><p>この通知、初期セットアップ時からずっと表示されていたのだが、Mattermost自体は普通に使えており、<a href="https://forum.mattermost.com/t/intermittent-the-server-is-not-reachable-for-some-users-on-mobile/16884/6">フォーラムにも同様の報告が上がっていた</a>ので、まあネイティブアプリのバグかなと思って放置していた。しかし実際にはWebSocket接続が失敗していたために表示されていたっぽい／(^o^)＼</p>
<p>アプリがある程度は動いていたのは、WebSocketを使わない基本的なAPI通信が問題なく通っていたからではないかと思う。（通知やBoardsなどのリアルタイムUIは動かないが、通常の投稿やチャンネル閲覧などはHTTP通信だけで動作していた、ということなんじゃないかと思う。たぶん……）</p>
<h6 id="heading-11">　﻿</h6>
<p>何はともあれ、これでBoardsが使えるようになった。Slack的なコミュニケーションとNotion的なやつが同一アプリ内で使えるの快適すぐる！！！！！</p>
<div class="image-wrapper"><img src="/images/diary/mattermost-websocket-error/bpgrweqlqm2x7pwvqlxy.png" alt=""></div><h6 id="heading-12">　﻿</h6>
<p>Boardのセットアップに関する記事はこの土日に書く。この一週間ですっかりMattermostの虜や〜〜〜</p>

            
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                document.querySelectorAll('.image-wrapper img').forEach(function(img) {
                                    const altText = img.getAttribute('alt');
                                    if (altText) {
                                        img.parentElement.setAttribute('data-alt', altText);
                                    } else {
                                        console.log('alt属性が空のimgタグを検出しました');
                                        img.parentElement.classList.add('no-alt'); 
                                    }
                                });
                            });
                        </script>
                        
                        <div class="social-action">
                            <div class="social-action__left">
                                <div class="social-action__line">
                                    <div class="social-action__line-icon"></div>
                                    <a href="https://lin.ee/eVcRqAC" target="_blank">
                                        このブログの更新通知をLINEで受け取る
                                    </a>
                                </div>
                            </div>
                            <div class="social-action__right">
                                <a href="https://twitter.com/intent/tweet?text=Mattermost%e3%81%aeWebSocket%e6%8e%a5%e7%b6%9a%e3%82%a8%e3%83%a9%e3%83%bc%e3%82%92%e8%a7%a3%e6%b1%ba%e3%81%97%e3%81%9f&url=http%3a%2f%2flocalhost%3a1313%2fcolumn%2fmattermost-websocket-error%2f" target="_blank" class="social-action__x" data-show-count="false"></a>
                                <a href="http://b.hatena.ne.jp/entry/http://localhost:1313/column/mattermost-websocket-error/" target="_blank" class="social-action__hatena"></a>
                                
                            </div>
                        </div>
                    </article>
                
                    <article id="hugo-v0.125%E4%BB%A5%E9%99%8D%E3%81%A7-_index.md-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%8C%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F%E4%BB%B6" class="article-item">
                        <p class="date">2025-05-24</p>
                        <a href="http://localhost:1313/column/hugo-section-page-not-rendering/">
                            <h1>Hugo v0.125以降で _index.md を使ったセクションページが表示されなくなった件</h1>
                        </a>
                        
                        <p>Hugoでは、<code>content/about/_index.md</code>  のようなファイルを配置することで、「about」というセクションのトップページを作ることができる。WordPressでいえばカスタム投稿タイプのアーカイブページ（一覧ページ）に近い仕組みだ。セクション全体の紹介や記事一覧に使われるページで、Hugoの用語では「セクションページ（Section Page）」または「ブランチページ（Branch Page）」と呼ばれている。</p>
<p>例えば、僕のサイトでは、</p>
<ul>
<li><code>ezeroms.com/about/about/</code></li>
<li><code>ezeroms.com/about/work/</code> </li>
<li><code>ezeroms.com/about/diary/</code> </li>
<li><code>ezeroms.com/about/shoulders-of-giants/</code> </li>
</ul>
<p>といったURLで表示されるページがそれにあたる。</p>
<p>で。今日このサイトを更新していたら、それらのセクションページが突如表示されなくなった。この記事では、その原因と解決方法を記録しておく。</p>
<h2 id="問題の背景">問題の背景</h2>
<p>Hugoでは、contentディレクトリ以下にあるMarkdownファイルが、layouts以下にあるテンプレートによってHTMLに変換（＝レンダリング）される。</p>
<p>具体的には、以下のような構成だ。</p>
<pre tabindex="0"><code>content/
  about/
    _index.md
  diary
    _index.md
  shoulders-of-giants
    _index.md
  work
    _index.md
  
layouts/
  about/
    index.html
  diary
    index.html
  shoulders-of-giants
    index.html
  work
    index.html
</code></pre><h6 id="heading">　﻿</h6>
<p>content/about/_index.md</p>
<pre tabindex="0"><code>---
title: &#34;About&#34;
layout: &#34;index&#34;
---

ここにコンテンツを書く
</code></pre><h6 id="heading-1">　﻿</h6>
<p>layouts/about/index.html</p>
<pre tabindex="0"><code>&lt;section&gt;
  &lt;article&gt;
   {{ .Content }}
  &lt;/article&gt;
&lt;/section&gt;
</code></pre><p>このように、Markdown側では <code>layout: &quot;index&quot;</code>  を指定し、Hugoはそのレイアウトに従ってHTMLを生成してくれる。つまり、コンテンツは.mdファイルに書き、構造や見た目は.htmlテンプレートに記述することで、Markdownさえ書ければWebサイトが更新できるようになる。</p>
<p>この仕組みによって、例えばDecapCMSのようなヘッドレスCMSを使えば、mdファイルの編集だけでサイトの更新が可能になる。出力されるのはあくまで静的な html ファイルだが、裏側では動的にCMSを運用しているような体験が得られるのだ。</p>
<h6 id="heading-2">　﻿</h6>
<p>しかし今回localでbuildしたところ、buildは正常に完了したものの、該当するセクションページのHTMLが生成されない（「意図したファイルが public/ 以下に出てこない」）という問題が発生した。</p>
<h2 id="原因hugoのアップデートでテンプレート解決が厳密化">原因：Hugoのアップデートでテンプレート解決が厳密化</h2>
<p>今回の原因は、Hugoの仕様変更（v0.125以降）によりテンプレートの解決ルールがより厳密になったことだった。最近Macを新しくした際にHugoも最新バージョン（v0.134.1）でインストールし直したため、この問題が表面化したのだろう。</p>
<p>以前のHugoでは、<code>_index.md</code>  に対して <code>layout: &quot;index&quot;</code>  を指定していても、なんとなく <code>layouts/about/index.html</code>  が使われていたのだが、最新のHugoではそのような曖昧な解決が効かなくなり、テンプレートは適切な名称でなければならなくなった。というか、そもそも僕は <code>index.html</code>  が適切な型名でないことを今回調べて初めて知った( ＾ω＾) </p>
<p><a href="https://discourse.gohugo.io/t/index-md-file-rendering-correctly-then-overwritten-by-default-single-html/52059">index.md file rendering correctly then overwritten by default single.html | Hugo Forums</a></p>
<h2 id="解決策テンプレートファイル名とレイアウト指定の変更">解決策：テンプレートファイル名とレイアウト指定の変更</h2>
<p>以下のように修正したらセクションページが表示されるようになったよ＼(^o^)／</p>
<h6 id="heading-3">　﻿</h6>
<p>テンプレートファイルのファイル名を変更</p>
<pre tabindex="0"><code># 修正前
layouts/
  about/
    index.html
  diary/
    index.html
  shoulders-of-giants/
    index.html
  work/
    index.html

# 修正後
layouts/
  about/
    list.html
  diary/
    list.html
  shoulders-of-giants/
    list.html
  work/
    list.html
</code></pre><h6 id="heading-4">　﻿</h6>
<p>Markdownファイル内のレイアウト指定を変更</p>
<pre tabindex="0"><code># 修正前
layout: &#34;index&#34;

# 修正後
layout: &#34;list&#34;
</code></pre>
            
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                document.querySelectorAll('.image-wrapper img').forEach(function(img) {
                                    const altText = img.getAttribute('alt');
                                    if (altText) {
                                        img.parentElement.setAttribute('data-alt', altText);
                                    } else {
                                        console.log('alt属性が空のimgタグを検出しました');
                                        img.parentElement.classList.add('no-alt'); 
                                    }
                                });
                            });
                        </script>
                        
                        <div class="social-action">
                            <div class="social-action__left">
                                <div class="social-action__line">
                                    <div class="social-action__line-icon"></div>
                                    <a href="https://lin.ee/eVcRqAC" target="_blank">
                                        このブログの更新通知をLINEで受け取る
                                    </a>
                                </div>
                            </div>
                            <div class="social-action__right">
                                <a href="https://twitter.com/intent/tweet?text=Hugo%20v0.125%e4%bb%a5%e9%99%8d%e3%81%a7%20_index.md%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%9f%e3%82%bb%e3%82%af%e3%82%b7%e3%83%a7%e3%83%b3%e3%83%9a%e3%83%bc%e3%82%b8%e3%81%8c%e8%a1%a8%e7%a4%ba%e3%81%95%e3%82%8c%e3%81%aa%e3%81%8f%e3%81%aa%e3%81%a3%e3%81%9f%e4%bb%b6&url=http%3a%2f%2flocalhost%3a1313%2fcolumn%2fhugo-section-page-not-rendering%2f" target="_blank" class="social-action__x" data-show-count="false"></a>
                                <a href="http://b.hatena.ne.jp/entry/http://localhost:1313/column/hugo-section-page-not-rendering/" target="_blank" class="social-action__hatena"></a>
                                
                            </div>
                        </div>
                    </article>
                
                    <article id="mattermost%E3%82%92%E3%82%BB%E3%83%AB%E3%83%95%E3%83%9B%E3%82%B9%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B" class="article-item">
                        <p class="date">2025-05-22</p>
                        <a href="http://localhost:1313/column/mattermost/">
                            <h1>Mattermostをセルフホスティングする</h1>
                        </a>
                        
                        <div class="image-wrapper"><img src="/images/diary/mattermost/47.png" alt=""></div><h2 id="mattermostとは">Mattermostとは</h2>
<p>Mattermostは、Slackに似たUIを持つ、オープンソースのコラボレーションツールだ。</p>
<p>自分たちでサーバーを用意して運用する「セルフホスティング」に対応しており、ユーザー数や機能に応じて課金されることなく自由に使うことができる。すごい。これでSlack重税ともおさらばや！！</p>
<p><a href="https://mattermost.com/">https://mattermost.com/</a></p>
<h6 id="heading">　﻿</h6>
<div class="image-wrapper"><img src="/images/diary/mattermost/44.png" alt="Slack重税 2025年5月現在"></div><h2 id="mattermostセルフホスティングでできること">Mattermost（セルフホスティング）でできること</h2>
<ul>
<li>基本的なチャンネルベースのチャット（Slackと同様のUI）</li>
<li>ダイレクトメッセージ</li>
<li>チャンネルの公開設定（オープンチャンネル or プライベートチャンネル）</li>
<li>スレッド形式での返信</li>
<li>メンション @here, @channel, @username など</li>
<li>画像・PDFなどの添付＆プレビュー</li>
<li>iOS / Androidアプリあり（Mattermost公式）</li>
<li>投稿内でのMarkdown記法対応</li>
<li>Bot / Webhook: Incoming / Outgoing webhookあり</li>
<li>Plugin / Integration: Trello、GitLab、Jiraなどの連携プラグインあり</li>
</ul>
<h2 id="mattermostセルフホスティングでできないこと">Mattermost（セルフホスティング）でできないこと</h2>
<ul>
<li>音声通話: Slackのハドルのようなものは標準では非搭載（プラグインが必要）</li>
<li>画面共有: 上記のプラグインを使っても画面共有はできない</li>
<li>SAML / LDAP: Enterprise Editionならできるっぽい</li>
<li>監査ログ / EMM連携: Enterprise Editionならできるっぽい</li>
</ul>
<h6 id="heading-1">　﻿</h6>
<p>Slackの利用料を払うのが難しい規模のプロジェクトでは、Discordが使われることが多いと思う。</p>
<p>ただ、個人的にはDiscordのスレッド返信がどうにも使いづらく、結果としてテキストでのやり取りが整然と進められないのがずっと気になっていた。Mattermostではその点がしっかり解消されており、チャンネル内での会話の整理がしやすそうという印象。一方で、Discordのような「ゆるくつながる」音声通話のスタイルを大事にしたい場合には、Mattermostは少し堅すぎるというか、そういう用途にはあまり向いていない。</p>
<p>「本当はSlackのようなスタイルのコミュニケーションをしたいのだけど、仕方なくDiscordを使っている」というようなプロジェクトには、Mattermostはちょうどよい選択肢になると思う。</p>
<h6 id="heading-2">　﻿</h6>
<p>早速環境を用意してみたので、以下作業メモ。</p>
<h2 id="1-サーバーを用意する">1. サーバーを用意する</h2>
<p>さくらのVPSで 4Gプランを契約（記事執筆時で月額3,960円。年払いだともう少し安くなる）。</p>
<p>OSはUbuntu 22.04を選択。IPアドレスが払い出される。</p>
<p><a href="https://vps.sakura.ad.jp/">https://vps.sakura.ad.jp/</a></p>
<div class="image-wrapper"><img src="/images/diary/mattermost/45.png" alt=""></div><h6 id="heading-3">﻿</h6>
<p>契約後、コントロールパネルにアクセスしてサーバーを起動</p>
<p><a href="https://secure.sakura.ad.jp/vps/servers">https://secure.sakura.ad.jp/vps/servers</a></p>
<h2 id="2-sshでログインしてセットアップ開始">﻿2. SSHでログインしてセットアップ開始</h2>
<pre tabindex="0"><code>ssh root@&lt;VPSのIPアドレス&gt;
</code></pre><p>最初に自動生成されたパスワードを使ってログイン</p>
<h2 id="3-初期設定dockerの導入">3. 初期設定＆Dockerの導入</h2>
<pre tabindex="0"><code># パッケージ情報を更新
sudo apt update &amp;&amp; sudo apt upgrade -y

# Dockerとdocker-composeをインストール
sudo apt install -y docker.io docker-compose

# Dockerを自動起動するように設定
sudo systemctl enable docker
</code></pre><h2 id="4-mattermost用ディレクトリの作成">4﻿. Mattermost用ディレクトリの作成</h2>
<pre tabindex="0"><code>sudo mkdir -p /opt/mattermost
cd /opt/mattermost
</code></pre><h2 id="5-docker-composeyml-の作成">5. docker-compose.yml の作成</h2>
<pre tabindex="0"><code>sudo nano docker-compose.yml
</code></pre><pre tabindex="0"><code>version: &#34;3&#34;

services:
  db:
    image: postgres:13
    restart: always
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: mmuser_password
      POSTGRES_DB: mattermost
    volumes:
      - ./volumes/db:/var/lib/postgresql/data

  app:
    image: mattermost/mattermost-team-edition
    restart: always
    ports:
      - &#34;8065:8065&#34;
    environment:
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:mmuser_password@db:5432/mattermost?sslmode=disable
      MM_SERVICESETTINGS_SITEURL: http://&lt;VPSのIPアドレス&gt;:8065
    volumes:
      - ./volumes/app/mattermost:/mattermost/data
    depends_on:
      - db
</code></pre><p>nanoの保存コマンド: Ctrl + O → Enter → Ctrl + X</p>
<h2 id="6-コンテナの起動">6. コンテナの起動</h2>
<pre tabindex="0"><code>sudo docker-compose up -d
</code></pre><h2 id="7-サーバーのパケットフィルターを設定">7. サーバーのパケットフィルターを設定</h2>
<p>ポート 8065 でアクセスしたいので、パケットフィルターを設定する。ついでにこのあと必要なポートも登録しておく。</p>
<div class="image-wrapper"><img src="/images/diary/mattermost/48.png" alt=""></div><h2 id="8-動作確認">8. 動作確認</h2>
<p>ブラウザからVPSのIPアドレスを直叩きしてアクセス！</p>
<p><a href="http://160.16.197.152:8065">http://160.16.197.152:8065</a></p>
<div class="image-wrapper"><img src="/images/diary/mattermost/49.png" alt=""></div><h2 id="9-サブドメインの割り当て">9. サブドメインの割り当て</h2>
<p>ドメイン管理サービスでDNS設定</p>
<pre tabindex="0"><code>host: chat
type: A
data: 160.16.197.152
</code></pre><p>Google Domains亡きあと、惰性でSquarespaceを使い続けているけれど、ずっとCloudflare Registrarに移行したいと思っている。（こういう地味な作業に腰が上がらなくなるの、確実に加齢の兆候だと思う。）</p>
<h2 id="10-nginxでリバースプロキシを設定">10. Nginxでリバースプロキシを設定</h2>
<p>Mattermostのポート8065番を、標準の80番/443番（HTTPS）に乗せかえる必要がある。</p>
<p>Let’s Encryptは、ポート80（HTTP）を使って認証するため、Mattermost が直接 8065番で動いてると認証できない。そこで、Nginxで80番を受付けてMattermostに中継（proxy）する形を取る。</p>
<pre tabindex="0"><code>sudo apt install nginx
sudo nano /etc/nginx/sites-available/mattermost
</code></pre><pre tabindex="0"><code>server {
    listen 80;
    server_name chat.chooning.app;

    location / {
        proxy_pass http://localhost:8065;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
</code></pre><h6 id="heading-4">﻿</h6>
<p>有効化</p>
<pre tabindex="0"><code># sites-available に置いた設定ファイルを sites-enabled にシンボリックリンクで追加
sudo ln -s /etc/nginx/sites-available/mattermost /etc/nginx/sites-enabled/

# 設定ファイルの文法チェック
sudo nginx -t

# Nginxの再読み込み（設定反映）
sudo systemctl reload nginx
</code></pre><h6 id="heading-5">﻿</h6>
<p>SSL化（HTTPS対応）</p>
<pre tabindex="0"><code># certbot（証明書取得ツール）と nginx連携用のプラグインをインストール
sudo apt install certbot python3-certbot-nginx

# chat.chooning.app ドメインに対してSSL証明書を取得し、
# Nginxの設定に自動で組み込む（ポート443対応も自動設定される）
sudo certbot --nginx -d chat.chooning.app
</code></pre><p>メールアドレス入力、利用規約に同意、リダイレクト（HTTP→HTTPS）を Yes に。</p>
<h2 id="11-動作確認">11. 動作確認</h2>
<p>割り当てたドメインにブラウザでアクセスして確認</p>
<p><a href="http://chat.chooning.app">http://chat.chooning.app</a></p>

            
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                document.querySelectorAll('.image-wrapper img').forEach(function(img) {
                                    const altText = img.getAttribute('alt');
                                    if (altText) {
                                        img.parentElement.setAttribute('data-alt', altText);
                                    } else {
                                        console.log('alt属性が空のimgタグを検出しました');
                                        img.parentElement.classList.add('no-alt'); 
                                    }
                                });
                            });
                        </script>
                        
                        <div class="social-action">
                            <div class="social-action__left">
                                <div class="social-action__line">
                                    <div class="social-action__line-icon"></div>
                                    <a href="https://lin.ee/eVcRqAC" target="_blank">
                                        このブログの更新通知をLINEで受け取る
                                    </a>
                                </div>
                            </div>
                            <div class="social-action__right">
                                <a href="https://twitter.com/intent/tweet?text=Mattermost%e3%82%92%e3%82%bb%e3%83%ab%e3%83%95%e3%83%9b%e3%82%b9%e3%83%86%e3%82%a3%e3%83%b3%e3%82%b0%e3%81%99%e3%82%8b&url=http%3a%2f%2flocalhost%3a1313%2fcolumn%2fmattermost%2f" target="_blank" class="social-action__x" data-show-count="false"></a>
                                <a href="http://b.hatena.ne.jp/entry/http://localhost:1313/column/mattermost/" target="_blank" class="social-action__hatena"></a>
                                
                            </div>
                        </div>
                    </article>
                
                    <article id="tinder-swipe-stories" class="article-item">
                        <p class="date">2025-02-19</p>
                        <a href="http://localhost:1313/column/tinder-swipe-stories/">
                            <h1>Tinder Swipe Stories</h1>
                        </a>
                        
                        <p>Tinderが「Tinder Swipe Stories」という企画をやっている。Tinderでの出会いをテーマにした体験談を集める試みだ。</p>
<p><a href="https://docs.google.com/forms/d/e/1FAIpQLSfSTpis5G-v7cwuxfhaODtIS_AfIHOz_eS4-Dog-R0JaYBOWA/viewform">Tinder Swipe Stories</a></p>
<div class="image-wrapper"><img src="/images/diary/tinder-swipe-stories/tinder-swipe-stories.png" alt=""></div><blockquote>
<p>Hey Tinder member,</p>
<p>We can’t wait for you to share your Tinder Swipe Story! Whether they are your love match made in heaven, your unexpected best friend for life, somewhere in between or none of the above, we want to hear all about it :)</p></blockquote>
<p>この文面を読んで、「somewhere in between or none of the above」というフレーズが印象に残った。「運命の恋」や「生涯の親友」といった分かりやすい物語に収まらない関係が、確かに存在することを認め、その曖昧さをそのまま受け止めている。たった一度きりのもの、後になってようやく意味を持つもの、それらもすべて「いいよね」と包み込む軽やかさには、実にTinderらしい強さがある。</p>
<p>というのも、様々なマッチングアプリが「真面目な出会い」をプロモーションする中で、Tinderだけは「チャラい」出会いの可能性を否定していない。</p>
<div class="image-wrapper"><img src="/images/diary/tinder-swipe-stories/09.jpg" alt=""></div><div class="image-wrapper"><img src="/images/diary/tinder-swipe-stories/10.jpg" alt=""></div><div class="image-wrapper"><img src="/images/diary/tinder-swipe-stories/11.jpg" alt=""></div><p>とはいえ、Tinderが90〜00年代の「出会い系」のように、匿名性が高く、目的がほぼ肉体関係に限定された即席マッチングサービスなのかというと、そういう訳でもない</p>
<p>Tinderの本質は「人が人を求める」という情欲の一つひとつを、等しく扱うことにある。真剣に婚活するのも、親友を探すのも、一夜の関係を求めるのも、すべて「つながりたい」という欲求の一種に過ぎない。Tinderが目指しているのは、それらに倫理的な優劣をつけず、フラットに応えようとすることだ。</p>
<h6 id="heading">﻿</h6>
<p>その「つながる」という行為を、もう少し視覚的に、あるいは手触りのある形に落とし込んだマーケティング施策がある。</p>
<p>2022年の秋、Tinderが「Swipe Mart」という期間限定のポップアップストアを渋谷・宇田川町にオープンした。「Tinderが運営するコンビニ」というコンセプトの空間で、ブランドの世界観を体験できる施策である。</p>
<p>店内には、スナック菓子や清涼飲料水を模したTinder印のオリジナル商品が並び、Tinderブランドのアパレルグッズなども販売されていた。事前の告知を見て、スウェットや靴下を狙って行ったのだけれど、僕が着いたときにはすでに完売。開店から数分で即完したらしい。</p>
<div class="image-wrapper"><img src="/images/diary/tinder-swipe-stories/pl-img-4.jpeg" alt=""></div><div class="image-wrapper"><img src="/images/diary/tinder-swipe-stories/pl-img-9.jpeg" alt=""></div><div class="image-wrapper"><img src="/images/diary/tinder-swipe-stories/pl-img-10.jpeg" alt=""></div><div class="image-wrapper"><img src="/images/diary/tinder-swipe-stories/pl-img-13.jpeg" alt=""></div><div class="image-wrapper"><img src="/images/diary/tinder-swipe-stories/07-1.png" alt="目ぼしい商品は売り切れてしまっていたので、「スワイプブース」なるフォトブースで友達と写真を撮って帰ってきた。"></div><h6 id="heading-1">﻿</h6>
<p>無数に存在する誰かの中から、自分が「これだ」と思う相手を選ぶプロセスは、コンビニの陳列棚で商品を手に取る行為とよく似ている。</p>
<p>炭酸水にするか、スポーツドリンクにするか。一度はカゴに入れたけれど、やっぱり戻すかもしれない。誰かと過ごす時間も、Tinderを開いて右へ左へとスワイプする指の動きも、本質的にはこの（まるで記憶に残らないようなレベルの）迷いと決断の繰り返しだ。出会いとは、常に選択的接触の過程にある。</p>
<p>ただ、コンビニで買ったものが確実に身体に影響を与えるように、出会いもまた、単なる消費では終わらない。どんな動機であれ、選び取った人との関係は気づかぬうちに人生に何らかの痕跡を残していく。</p>
<p>それは意識されることのないうちに蓄積し、ある日ふとした瞬間に、自分のどこかに残っていたことに気づくのだろう。</p>
<p><a href="https://www.youtube.com/watch?v=Wczdy7emRds">https://www.youtube.com/watch?v=Wczdy7emRds</a></p>

            
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                document.querySelectorAll('.image-wrapper img').forEach(function(img) {
                                    const altText = img.getAttribute('alt');
                                    if (altText) {
                                        img.parentElement.setAttribute('data-alt', altText);
                                    } else {
                                        console.log('alt属性が空のimgタグを検出しました');
                                        img.parentElement.classList.add('no-alt'); 
                                    }
                                });
                            });
                        </script>
                        
                        <div class="social-action">
                            <div class="social-action__left">
                                <div class="social-action__line">
                                    <div class="social-action__line-icon"></div>
                                    <a href="https://lin.ee/eVcRqAC" target="_blank">
                                        このブログの更新通知をLINEで受け取る
                                    </a>
                                </div>
                            </div>
                            <div class="social-action__right">
                                <a href="https://twitter.com/intent/tweet?text=Tinder%20Swipe%20Stories&url=http%3a%2f%2flocalhost%3a1313%2fcolumn%2ftinder-swipe-stories%2f" target="_blank" class="social-action__x" data-show-count="false"></a>
                                <a href="http://b.hatena.ne.jp/entry/http://localhost:1313/column/tinder-swipe-stories/" target="_blank" class="social-action__hatena"></a>
                                
                            </div>
                        </div>
                    </article>
                
                    <article id="%E3%83%97%E3%83%AD%E3%83%80%E3%82%AF%E3%83%88%E9%96%8B%E7%99%BA%E3%81%A8%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%A8%E3%81%AE%E6%91%A9%E6%93%A6" class="article-item">
                        <p class="date">2024-06-20</p>
                        <a href="http://localhost:1313/column/friction-between-product-developer-and-users/">
                            <h1>プロダクト開発とユーザーとの摩擦</h1>
                        </a>
                        
                        <p>　5月から6月にかけて、Chooningのアップデートを重ね、新たな機能を続々とリリースした。アーティストのアカウント認証機能、プロフィール共有機能、Spotify視聴履歴に基づいたおすすめ投稿機能などを実装し、さらに中国語（繁体字）版インターフェースもリリースして、この夏は台湾市場への進出も見据えている。</p>
<p>　しかし、どんな施策も万人に受け入れられるわけではない。アプリのアップデートは歓迎されるばかりではなく、ときに「改悪だ」という厳しい意見も寄せられる。開発者は、データベースに記録される値や計測ツールの結果、インタビューを通じたユーザーの声など、様々な情報のもとに開発内容を決めている。それでも、すべてのユーザーを満足させることはできない。長くサービスを続けていれば、開発者とユーザーの間には大なり小なり摩擦が生じる。</p>
<h6 id="heading">　﻿</h6>
<p>　一般的によくあるのは、サービス側が収益性を高めようとする施策だろう。例えば、目立つ場所に広告を配置したり、広告の表示頻度を上げたりすればユーザーは不快に思う。動画や漫画の続きを見ようとして、下手くそなゲームのプレイ動画を数十秒見せられてイライラした経験をしたことのある人は多いだろう。Chooningにはそういった仕組みはないが、僕は会社員としてプロダクトを作っていたとき、この手の実装をする際には心苦しく思っていたし、実際にリリース後のSNSでユーザーの毒づく声を目にしてよく落ち込んでいた。</p>
<p>　Chooningでは収益性を求める施策は行っていないものの、だからといってユーザーの不満を買わずにやれているわけではない。むしろ、より切実な衝突を感じることがある。例えば、ユーザーのプロフィールをシェアできるようにした件については「お互いにフォローせず、時々お邪魔するのが楽しみだったのに」といった声が上がった（恐らく相互フォローを促進する意図があると受け止められたのだろう）。また、おすすめフィードを実装した件については「ファーストビューがメジャーなアーティストで埋め尽くされてしまい、自分の好きなマイナーアーティストを紹介しても届きづらくなった」という声が上がった。</p>
<p>　僕は常々、自分のプロダクトは技術や機能だけでなく、価値観の次元で勝負したいと思っている。Chooningでユーザーが体験できることは、「人と音楽との関わり方はこうあってほしい」という僕の価値観に基づいている。具体的には、Spotifyなどのサブスク（ストリーミング）サービスで音楽を手軽に聴きながらも、その音楽について向き合って考えたり、些細な思い出を語ったり、同好者と共感し合う時間を持って欲しい、というものだ。そのためにユーザーがスムーズに音楽を共有したり、見つけたり、交流したりできる機能を充実させている。僕のようなタイプの開発者には、そうやって価値観を形にしたものに触れてもらい、それを心地よいと感じてもらいたいと思う欲望がある。機能の追加や変更は、自分の価値観をより明確に伝えるためのメッセージでもある。</p>
<p>　だからこそ、仕様を変更したときに、それまで支持してくれていたユーザーが「これは求めているものじゃない」と言って離れていくのを見ると、価値観に共感してもらえなかった…という極めて個人的な喪失感を感じてしまう。それは、収益性の都合でユーザーに不満を持たれるよりもはるかに悲しい。収益性の向上はサービスの存続に不可欠であり、僕も運営者としての責務の一部として割り切ることができる。しかし、価値観の相違による意見の衝突は自分の気持ちの解決が難しい。「ごめんな、でも僕はこう思うんだ。分かってくれることがあれば嬉しい」と目を閉じるしかない。</p>
<h6 id="heading-1">　﻿</h6>
<p>　離れていってしまったユーザーのことは、いつも少し心に棘が刺さったような気持ちで残っている。自分のプロダクトを作るということは、自分の価値観を形にして社会に届けるということだ。そこでは多くの「Not for me」の声も受けることになる。ストアからダウンロードした僕のアプリを、翌月も使い続けてくれる人がどれくらいいるだろう？　その数字を見る度に、僕は他者との価値観の違いを認識する。あえて強がってみせるなら、それこそが、本気で物を作ることの面白さだと言えるかもしれない。</p>
<p>　プロダクトには成長していく段階があり、それに伴って作り手と使い手の関係も変わっていく。ある時期を共に過ごしたユーザーの一部が次の時期に離れていくことは避けられない。頭では理解しているのだが、それでも、一度プロダクトを気に入ってくれたユーザーには、ずっと使い続けてもらいたいと願ってしまう。</p>
<h6 id="heading-2">　﻿</h6>
<p>　ユーザーの声は大きい。少なくとも僕は、どんなに厳しい意見や的外れな批判でも、自分が生み出したものに対して感情を込めて意見をくれる人には感謝している。高校時代にゲームを作ったり、大学時代に友達とサービスを作っていた頃は、世の中の反応は全くなかった。それに比べれば、不満の声であったとしても「反応がある」というのは嬉しいことだ。作り手のモチベーションは、案外そんなものに支えられている。</p>

            
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                document.querySelectorAll('.image-wrapper img').forEach(function(img) {
                                    const altText = img.getAttribute('alt');
                                    if (altText) {
                                        img.parentElement.setAttribute('data-alt', altText);
                                    } else {
                                        console.log('alt属性が空のimgタグを検出しました');
                                        img.parentElement.classList.add('no-alt'); 
                                    }
                                });
                            });
                        </script>
                        
                        <div class="social-action">
                            <div class="social-action__left">
                                <div class="social-action__line">
                                    <div class="social-action__line-icon"></div>
                                    <a href="https://lin.ee/eVcRqAC" target="_blank">
                                        このブログの更新通知をLINEで受け取る
                                    </a>
                                </div>
                            </div>
                            <div class="social-action__right">
                                <a href="https://twitter.com/intent/tweet?text=%e3%83%97%e3%83%ad%e3%83%80%e3%82%af%e3%83%88%e9%96%8b%e7%99%ba%e3%81%a8%e3%83%a6%e3%83%bc%e3%82%b6%e3%83%bc%e3%81%a8%e3%81%ae%e6%91%a9%e6%93%a6&url=http%3a%2f%2flocalhost%3a1313%2fcolumn%2ffriction-between-product-developer-and-users%2f" target="_blank" class="social-action__x" data-show-count="false"></a>
                                <a href="http://b.hatena.ne.jp/entry/http://localhost:1313/column/friction-between-product-developer-and-users/" target="_blank" class="social-action__hatena"></a>
                                
                            </div>
                        </div>
                    </article>
                
                    <article id="hugo-&#43;-netlify-&#43;-decapcms-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%B5%E3%82%A4%E3%83%88%E6%A7%8B%E7%AF%89" class="article-item">
                        <p class="date">2024-06-09</p>
                        <a href="http://localhost:1313/column/building-a-website-with-hugo-netlify-decap-cms/">
                            <h1>Hugo &#43; Netlify &#43; DecapCMS を使ったサイト構築</h1>
                        </a>
                        
                        <p>35歳の誕生日を機に、個人サイト（ブログ）をリニューアルすることにした。</p>
<p>以前より、Hugo + Netlify を使って個人サイトを配信していたのだが、この仕組みには「記事の更新作業に手間がかかる」という問題があった。</p>
<p>静的サイトジェネレーター兼コンテンツ管理として Hugo があり、Netlify がホスティングを担っているのだが、実際に記事を更新する際は、次のような手順となる。</p>
<ul>
<li>Github リポジトリを pull する（僕は複数台のマシンを使っているので、ローカルを最新状態に同期する必要がある。）</li>
<li>mdファイルを追加し、そこにブログ記事を書く</li>
<li>Github に push する</li>
<li>Netlify が更新を検知し、build → deploy を実行する（＝サイトが更新される）</li>
</ul>
<p>この手順から、Github に対する操作を省きたい。つまり、一般的なブログサービスのように（あるいは Wordpress サイトのように）「ブラウザで管理画面を開き、記事を更新する」という手続きにしたい。</p>
<p>そこで Decap CMS（旧・Netlify CMS）を使ってみることにした。ヘッドレスCMSの代表格で、特にGitベースであるという点が大きい（コンテンツの変更履歴を Git で管理できる）。</p>
<p>また、併せてサイトのデザインも一新することにした。以前は Hugo に不慣れなこともあり、無料配布されていた Hugo テーマを流用して改造しながら使っていたのだが、その運用を4〜5年ほどしたことで Hugo の仕組みにもだいぶ詳しくなった。そこで Hugo テーマをフルスクラッチで作ってみることにした。</p>
<h2 id="各ツールの役割の確認">各ツールの役割の確認</h2>
<ul>
<li>Hugo : 静的サイトジェネレーター。Markdown ファイルを HTML に変換して静的なウェブサイトを生成してくれる。静的サイトにはロマンがある。Golangで書かれているため動作が高速で、Goテンプレートエンジンによる柔軟なテンプレートシステムが魅力的。</li>
<li>Netlify : 静的サイトのホスティングサービス。Git リポジトリと連携して自動デプロイを行う。</li>
<li>Decap CMS : オープンソースのヘッドレスCMS。GUIベースの管理画面を提供し、静的サイトジェネレーターと連携してコンテンツを管理する。実装後に重大な落とし穴が発覚する（後述）。</li>
</ul>
<h2 id="1-サイトの基本形を作成">1. サイトの基本形を作成</h2>
<p>まずはまっさらな状態から Hugo プロジェクトを作っていく。</p>
<h3 id="1-hugo-プロジェクトを作成">1. Hugo プロジェクトを作成</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>hugo new site ezeroms.com
</span></span><span style="display:flex;"><span>cd ezeroms.com
</span></span></code></pre></div><h3 id="2-カスタムテーマの準備">2. カスタムテーマの準備</h3>
<p>Hugo プロジェクトで推奨されている形は、root ディレクトリの下に <code>/site</code> とかで区切って、テーマ等を置くディレクトリを一段下で管理する方法だ。これは、root ディレクトリでサイト設計やデプロイに関するメタ情報を管理し、具体的なサイト自身の設定や見た目と分離することで、複数テーマも管理やスケーラビリティを確保しようとするものだ。</p>
<p>しかし、今回のサイトの場合はテーマを切り替えることはない（自分でアップデートし続ける）し、プロジェクトの規模も小さいので、構造のシンプルさを優先して全て root ディレクトリ直下で管理する方法にした。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ezeroms.com
</span></span><span style="display:flex;"><span>├── archetypes
</span></span><span style="display:flex;"><span>│   └── index.html
</span></span><span style="display:flex;"><span>├── content
</span></span><span style="display:flex;"><span>│   ├── about
</span></span><span style="display:flex;"><span>│   │   └── _index.md
</span></span><span style="display:flex;"><span>│   ├── diary
</span></span><span style="display:flex;"><span>│   │   └── _index.md
</span></span><span style="display:flex;"><span>│   ├── shoulders-of-giants
</span></span><span style="display:flex;"><span>│   │   └── _index.md
</span></span><span style="display:flex;"><span>│   └── work
</span></span><span style="display:flex;"><span>│       └── _index.md
</span></span><span style="display:flex;"><span>├── layouts
</span></span><span style="display:flex;"><span>│   ├── _default
</span></span><span style="display:flex;"><span>│   │   ├── baseof.html
</span></span><span style="display:flex;"><span>│   │   └── rss.xml
</span></span><span style="display:flex;"><span>│   ├── about
</span></span><span style="display:flex;"><span>│   │   └── index.html
</span></span><span style="display:flex;"><span>│   ├── diary
</span></span><span style="display:flex;"><span>│   │   ├── index.html
</span></span><span style="display:flex;"><span>│   │   └── single.html
</span></span><span style="display:flex;"><span>│   ├── month
</span></span><span style="display:flex;"><span>│   │   └── list.html
</span></span><span style="display:flex;"><span>│   ├── partials
</span></span><span style="display:flex;"><span>│   │   ├── header.html
</span></span><span style="display:flex;"><span>│   │   ├── footer.html
</span></span><span style="display:flex;"><span>│   │   ├── global-nav.html
</span></span><span style="display:flex;"><span>│   │   └── ...
</span></span><span style="display:flex;"><span>│   ├── shoulders-of-giants
</span></span><span style="display:flex;"><span>│   │   └── index.html
</span></span><span style="display:flex;"><span>│   ├── subject
</span></span><span style="display:flex;"><span>│   │   └── list.html
</span></span><span style="display:flex;"><span>│   ├── topic
</span></span><span style="display:flex;"><span>│   │   └── list.html
</span></span><span style="display:flex;"><span>│   │── work
</span></span><span style="display:flex;"><span>│   │   ├── index.html
</span></span><span style="display:flex;"><span>│   │   └── single.html
</span></span><span style="display:flex;"><span>│   └── index.html
</span></span><span style="display:flex;"><span>├── public
</span></span><span style="display:flex;"><span>├── static
</span></span><span style="display:flex;"><span>│   ├── admin
</span></span><span style="display:flex;"><span>│   │   ├── config.yml
</span></span><span style="display:flex;"><span>│   │   └── index.html
</span></span><span style="display:flex;"><span>│   ├── css
</span></span><span style="display:flex;"><span>│   └── images
</span></span><span style="display:flex;"><span>├── config.toml
</span></span><span style="display:flex;"><span>└── netlify.toml
</span></span></code></pre></div><ul>
<li>public : hugo server  で build されたファイルが格納される場所。キャッシュが邪魔しているのか？と思ったときは全削除したりする。</li>
<li>content/*/_index.md : 一見不要そうだが、ここに index の md ファイルがないとディレクトリを正しく認識してくれない。</li>
<li>static/admin : Decap CMS の管理画面用のファイル群。</li>
</ul>
<h2 id="2-本番環境と自動デプロイの設定">2. 本番環境と自動デプロイの設定</h2>
<h3 id="1-github-リポジトリの作成">1. GitHub リポジトリの作成</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git init
</span></span><span style="display:flex;"><span>git add .
</span></span><span style="display:flex;"><span>git commit -m <span style="color:#e6db74">&#34;Initial commit&#34;</span>
</span></span><span style="display:flex;"><span>git remote add origin &lt;GITHUB_REPO_URL&gt;
</span></span><span style="display:flex;"><span>git push -u origin main
</span></span></code></pre></div><h3 id="2-netlify-アカウントの作成">2. Netlify アカウントの作成</h3>
<h3 id="3-githubリポジトリの連携">3. Githubリポジトリの連携</h3>
<p>Netlify の管理画面で「New site from Git」を選択し、GitHubリポジトリを連携。</p>
<h3 id="4-ビルド設定">4. ビルド設定</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>Build Command: hugo
</span></span><span style="display:flex;"><span>Publish Directory: public
</span></span></code></pre></div><p>これで、Github の main ブランチが更新されると、Netlify側で自動デプロイが走るようになる。</p>
<h3 id="5-ドメイン設定">5. ドメイン設定</h3>
<p>Netlify の管理画面で <code>ezeroms.com</code> を割り当てる。</p>
<h2 id="3-詳細なサイト構築テーマファイルの編集">3. 詳細なサイト構築（テーマファイルの編集）</h2>
<p>layouts 以下のテーマファイルと static/css をひらすら編集し、理想的なデザインを作り上げていく。自分一人のプロジェクトということもあり、あらかじめ全てのページを Figma で作ることはせず、主だったページのレイアウト構成だけ Figma 上で検証して、スタイリングについては実装しながら検討していった。褒められた方法ではないが、こういうところがソロ・プロジェクトの爽快なところだ。</p>
<h3 id="コツ--テーマファイルへのマーキング">コツ : テーマファイルへのマーキング</h3>
<p>hugo server  で localhost を確認しながら作っていくのだが、描画されているページに適切なテーマファイルが当たっているのかどうか分からなくなる。（「このページにこのテーマファイルが当たってほしいのに当たらん〜〜〜〜」的なことが続く）</p>
<p>そこで、すべてのテーマファイルに以下のようなマーキングした上で、config.toml の設定と、テーマファイルのディレクトリやファイル名を少しずつ弄りながら検証していった。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- debug-info --&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">p</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;debug-info&#34;</span>&gt;File : /layouts/subject/list.html&lt;/<span style="color:#f92672">p</span>&gt;
</span></span></code></pre></div><p>最終的にこんなかんじで出来上がる。</p>
<div class="image-wrapper"><img src="/images/diary/building-a-website-with-hugo-netlify-decap-cms/01.webp" alt=""></div><div class="image-wrapper"><img src="/images/diary/building-a-website-with-hugo-netlify-decap-cms/02.webp" alt=""></div><div class="image-wrapper"><img src="/images/diary/building-a-website-with-hugo-netlify-decap-cms/03.webp" alt=""></div><div class="image-wrapper"><img src="/images/diary/building-a-website-with-hugo-netlify-decap-cms/04.webp" alt=""></div><h3 id="課題--urlスキーム">課題 : URLスキーム</h3>
<p>本当はもっとURLスキームに拘りたかったのだが、どうやってもできず（Decap CMS管理の範囲外を作ることになり）断念した。いい方法を知っている人がいたら教えてほしい。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 理想的なURLスキーム</span>
</span></span><span style="display:flex;"><span>ezeroms.com/diary/
</span></span><span style="display:flex;"><span>ezeroms.com/diary/subject/news/
</span></span><span style="display:flex;"><span>ezeroms.com/diary/month/2024-06/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 実際のURLスキーム</span>
</span></span><span style="display:flex;"><span>ezeroms.com/diary/
</span></span><span style="display:flex;"><span>ezeroms.com/subject/news/
</span></span><span style="display:flex;"><span>ezeroms.com/month/2024-06/
</span></span></code></pre></div><h2 id="4-cmsを導入してブラウザから更新できるようにする">4. CMSを導入してブラウザから更新できるようにする</h2>
<p>package.json を作成し、Decap CMSをインストール。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>npm init -y
</span></span><span style="display:flex;"><span>npm install netlify-cms-app
</span></span></code></pre></div><p>static/admin ディレクトリの config.yml 、index.html を編集してセットアップし、ezeroms.com/admin にアクセスすれば管理画面が使えるようになる。めっちゃ簡単だ。</p>
<p>管理画面の自由度がとても高く config.yml で設定すると一覧の表示項目も柔軟に変更することができる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">git-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">branch</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">media_folder</span>: <span style="color:#e6db74">&#34;/static/images/uploads&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">public_folder</span>: <span style="color:#e6db74">&#34;/images/uploads&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">collections</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;about&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;About&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">folder</span>: <span style="color:#e6db74">&#34;content/about&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">slug</span>: <span style="color:#e6db74">&#34;{{fields.slug}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Body&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;body&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;markdown&#34;</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;{{body}}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;diary&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Diary&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">folder</span>: <span style="color:#e6db74">&#34;content/diary&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">slug</span>: <span style="color:#e6db74">&#34;{{fields.slug}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">media_folder</span>: <span style="color:#e6db74">&#34;/static/images/diary/{{fields.slug}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">public_folder</span>: <span style="color:#e6db74">&#34;/images/diary/{{fields.slug}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Title&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;string&#34;</span> }
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Date&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;date&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;datetime&#34;</span><span style="color:#f92672">, date_format</span>: <span style="color:#e6db74">&#34;YYYY-MM-DD&#34;</span><span style="color:#f92672">, time_format</span>: <span style="color:#66d9ef">false</span> }
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Slug&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;slug&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;string&#34;</span> }
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Month&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;month&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;list&#34;</span> }
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Subject&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;subject&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;select&#34;</span><span style="color:#f92672">, multiple: true, options</span>: [<span style="color:#e6db74">&#34;news&#34;</span>, <span style="color:#e6db74">&#34;music&#34;</span>, <span style="color:#e6db74">&#34;manga-and-anime&#34;</span>, <span style="color:#e6db74">&#34;movies-and-dramas&#34;</span>, <span style="color:#e6db74">&#34;comedy&#34;</span>, <span style="color:#e6db74">&#34;gaming&#34;</span>, <span style="color:#e6db74">&#34;sports&#34;</span>, <span style="color:#e6db74">&#34;books-and-magazines&#34;</span>, <span style="color:#e6db74">&#34;languages-and-foreign-cultures&#34;</span>, <span style="color:#e6db74">&#34;design-and-creative&#34;</span>, <span style="color:#e6db74">&#34;internet-and-technology&#34;</span>, <span style="color:#e6db74">&#34;natural-science&#34;</span>, <span style="color:#e6db74">&#34;humanities-and-social-sciences&#34;</span>] }
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Body&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;body&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;markdown&#34;</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;{{date | date(&#39;YYYY-MM-DD&#39;)}} | {{body | truncate(280, &#39;...&#39;)}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sort</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">field</span>: <span style="color:#e6db74">&#34;date&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">direction</span>: <span style="color:#e6db74">&#34;desc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;work&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Work&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">folder</span>: <span style="color:#e6db74">&#34;content/work&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">slug</span>: <span style="color:#e6db74">&#34;{{fields.slug}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">media_folder</span>: <span style="color:#e6db74">&#34;/static/images/work/{{fields.slug}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">public_folder</span>: <span style="color:#e6db74">&#34;/images/work/{{fields.slug}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Title&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;string&#34;</span> }
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Date&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;date&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;datetime&#34;</span><span style="color:#f92672">, date_format</span>: <span style="color:#e6db74">&#34;YYYY-MM-DD&#34;</span><span style="color:#f92672">, time_format</span>: <span style="color:#66d9ef">false</span> }
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Slug&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;slug&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;string&#34;</span> }
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Image&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;image&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;image&#34;</span> }
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Body&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;body&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;markdown&#34;</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;{{date | date(&#39;YYYY-MM-DD&#39;)}} | {{title}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sort</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">field</span>: <span style="color:#e6db74">&#34;date&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">direction</span>: <span style="color:#e6db74">&#34;desc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;shoulders-of-giants&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;The shoulders of Giants&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">folder</span>: <span style="color:#e6db74">&#34;content/shoulders-of-giants&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">slug</span>: <span style="color:#e6db74">&#34;{{fields.slug}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fields</span>:
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Topic&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;topic&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;list&#34;</span>}
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">label</span>: <span style="color:#e6db74">&#34;Body&#34;</span><span style="color:#f92672">, name</span>: <span style="color:#e6db74">&#34;body&#34;</span><span style="color:#f92672">, widget</span>: <span style="color:#e6db74">&#34;markdown&#34;</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">summary</span>: <span style="color:#e6db74">&#34;{{body | truncate(280, &#39;...&#39;)}}　　Topic {{topic}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sort</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">field</span>: <span style="color:#e6db74">&#34;body&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">direction</span>: <span style="color:#e6db74">&#34;asc&#34;</span>
</span></span></code></pre></div><h2 id="decap-cms-の落とし穴">Decap CMS の落とし穴</h2>
<p>さて、これで理想的な個人ブログの運用体制が構築できた…と思っていたのだが、ここで Decap CMS の大きな落とし穴が発覚する。</p>
<p>記事のテキストフィールドが、日本語入力に対応できていないのだ。漢字変換をしようとしたときにキャレットの位置がズレてしまい、正常に入力作業をすることができない。</p>
<p><a href="https://github.com/decaporg/decap-cms/issues/1347">Updating Slate editor to support Korean</a></p>
<p>どうやら Slate のバージョンが古いのが原因らしく、改善のためのプルリクは出ているのだがスルーされているっぽい。</p>
<p>（写真）
Issueが立っていたのでむなしくコメントを残しておいた。</p>
<p>なので、このサイトの実際の運用は次のようになっている。</p>
<ul>
<li>UpNote でコンテンツ管理（UpNote はモバイル用のネイティブアプリが用意されている）</li>
<li>UpNote から DecapCMS にコピペして記事を更新</li>
</ul>
<p>記事の編集作業部分をテキストエディタに外出ししている状態だ。以前に比べれば格段に更新しやすくはなったものの、できればブラウザで完結する運用を目指したい。</p>
<p>もちろん、ヘッドレスCMSには Decap CMS 以外にも選択肢はあるのだが、Netlify との相性と「無料で使える」という条件で探すと少し絞られてしまう（APIでやりとりするものは使いたくない）。また、できればスマホから更新ができるように、モバイル用インターフェースが提供されているとなお嬉しい。もう少し調べてみようと思う。</p>

            
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                document.querySelectorAll('.image-wrapper img').forEach(function(img) {
                                    const altText = img.getAttribute('alt');
                                    if (altText) {
                                        img.parentElement.setAttribute('data-alt', altText);
                                    } else {
                                        console.log('alt属性が空のimgタグを検出しました');
                                        img.parentElement.classList.add('no-alt'); 
                                    }
                                });
                            });
                        </script>
                        
                        <div class="social-action">
                            <div class="social-action__left">
                                <div class="social-action__line">
                                    <div class="social-action__line-icon"></div>
                                    <a href="https://lin.ee/eVcRqAC" target="_blank">
                                        このブログの更新通知をLINEで受け取る
                                    </a>
                                </div>
                            </div>
                            <div class="social-action__right">
                                <a href="https://twitter.com/intent/tweet?text=Hugo%20%2b%20Netlify%20%2b%20DecapCMS%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%9f%e3%82%b5%e3%82%a4%e3%83%88%e6%a7%8b%e7%af%89&url=http%3a%2f%2flocalhost%3a1313%2fcolumn%2fbuilding-a-website-with-hugo-netlify-decap-cms%2f" target="_blank" class="social-action__x" data-show-count="false"></a>
                                <a href="http://b.hatena.ne.jp/entry/http://localhost:1313/column/building-a-website-with-hugo-netlify-decap-cms/" target="_blank" class="social-action__hatena"></a>
                                
                            </div>
                        </div>
                    </article>
                
            

            </ul>
        </div>
    </section>

                </main>

                
                <aside class="layout-tags" aria-label="セカンダリーナビゲーション">
                    
    <div class="diary-secondary-nav">
    <div class="diary-secondary-nav__section">
        <p class="diary-secondary-nav__heading">Tags</p>
        <div class="tweet-secondary-nav__tags">
            
            
                
                    
                        
                            
                        
                    
                        
                            
                        
                    
                
            
                
                    
                        
                    
                        
                            
                        
                    
                
            
                
                    
                        
                            
                        
                    
                        
                            
                        
                    
                        
                            
                        
                    
                        
                            
                        
                    
                
            
                
                    
                        
                            
                        
                    
                        
                            
                        
                    
                        
                            
                        
                    
                
            
                
                    
                        
                            
                        
                    
                        
                    
                
            
                
                    
                        
                    
                        
                    
                        
                            
                        
                    
                
            
                
                    
                        
                    
                        
                            
                        
                    
                        
                    
                
            
                
                    
                        
                            
                        
                    
                        
                    
                        
                            
                        
                    
                
            
            
            
                <span class="sidebar-tag" data-tag="SNS">SNS</span>
            
                <span class="sidebar-tag" data-tag="コミュニケーション">コミュニケーション</span>
            
                <span class="sidebar-tag" data-tag="ライブ">ライブ</span>
            
                <span class="sidebar-tag" data-tag="企画">企画</span>
            
                <span class="sidebar-tag" data-tag="佐渡">佐渡</span>
            
                <span class="sidebar-tag" data-tag="友情">友情</span>
            
                <span class="sidebar-tag" data-tag="台湾">台湾</span>
            
                <span class="sidebar-tag" data-tag="回転寿司">回転寿司</span>
            
                <span class="sidebar-tag" data-tag="引越し">引越し</span>
            
                <span class="sidebar-tag" data-tag="文化">文化</span>
            
                <span class="sidebar-tag" data-tag="横浜">横浜</span>
            
                <span class="sidebar-tag" data-tag="農作業">農作業</span>
            
                <span class="sidebar-tag" data-tag="音楽">音楽</span>
            
                <span class="sidebar-tag" data-tag="食べ物">食べ物</span>
            
                <span class="sidebar-tag" data-tag="高円寺">高円寺</span>
            
        </div>
    </div>
</div>


                </aside>
                
            </div>
        </div>
    </div>

    
    

<script async src="https://www.googletagmanager.com/gtag/js?id=G-K021MTL6NX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-K021MTL6NX');
</script>



    
    <script>
        (function() {
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', handleExternalLinks);
            } else {
                handleExternalLinks();
            }

            function handleExternalLinks() {
                const baseURL = 'http:\/\/localhost:1313\/';
                const baseHost = baseURL ? new URL(baseURL).hostname : window.location.hostname;
                
                
                const articleLinks = document.querySelectorAll('.article-item a[href]');
                
                articleLinks.forEach(function(link) {
                    const href = link.getAttribute('href');
                    
                    
                    if (!href || link.hasAttribute('target')) {
                        return;
                    }
                    
                    
                    if (href.startsWith('#') || 
                        href.startsWith('/') || 
                        href.startsWith('./') ||
                        href.startsWith('../') ||
                        (href.startsWith('http') && new URL(href, window.location.href).hostname === baseHost)) {
                        
                        return;
                    }
                    
                    
                    if (href.startsWith('http://') || href.startsWith('https://') || href.startsWith('//')) {
                        link.setAttribute('target', '_blank');
                        link.setAttribute('rel', 'noopener noreferrer');
                    }
                });
            }
        })();
    </script>

    
    <script>
        (function() {
            function initSidebarMinimize() {
                const sidebar = document.querySelector('.layout-sidebar');
                const minimizeBtn = document.getElementById('sidebar-minimize-btn');
                
                if (!sidebar || !minimizeBtn) return;
                
                
                
                updateButtonState();
                
                
                minimizeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    sidebar.classList.toggle('is-minimized');
                    updateButtonState();
                });
                
                function updateButtonState() {
                    const isMinimized = sidebar.classList.contains('is-minimized');
                    if (isMinimized) {
                        minimizeBtn.setAttribute('aria-label', 'サイドバーを最大化');
                        minimizeBtn.setAttribute('data-tooltip', 'メニューを表示する');
                        minimizeBtn.querySelector('svg').style.transform = 'rotate(180deg)';
                    } else {
                        minimizeBtn.setAttribute('aria-label', 'サイドバーを最小化');
                        minimizeBtn.setAttribute('data-tooltip', 'メニューを非表示にする');
                        minimizeBtn.querySelector('svg').style.transform = 'rotate(0deg)';
                    }
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSidebarMinimize);
            } else {
                initSidebarMinimize();
            }
        })();
    </script>

    <script>
        (function() {
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initHeaderScroll);
            } else {
                initHeaderScroll();
            }

            function initHeaderScroll() {
                const header = document.querySelector('.layout-header');
                if (!header) {
                    console.log('Header not found');
                    return;
                }

                
                if (header.children.length === 0) {
                    return;
                }

                let lastScrollTop = 0;
                let scrollTimeout = null;
                let isScrollingDown = false;
                let ticking = false;

                function getScrollTop() {
                    return window.pageYOffset || document.documentElement.scrollTop || 0;
                }

                function handleScroll() {
                    const scrollTop = getScrollTop();
                    
                    
                    if (Math.abs(scrollTop - lastScrollTop) < 1) {
                        return;
                    }

                    const scrollingDown = scrollTop > lastScrollTop;
                    const scrollingUp = scrollTop < lastScrollTop;

                    
                    if (scrollTimeout) {
                        clearTimeout(scrollTimeout);
                        scrollTimeout = null;
                    }

                    
                    if (scrollTop <= 100) {
                        header.classList.remove('hidden');
                        isScrollingDown = false;
                        lastScrollTop = scrollTop;
                        return;
                    }

                    
                    if (scrollingUp) {
                        header.classList.remove('hidden');
                        isScrollingDown = false;
                    }
                    
                    else if (scrollingDown) {
                        header.classList.add('hidden');
                        isScrollingDown = true;
                    }

                    lastScrollTop = scrollTop;

                    
                    if (isScrollingDown) {
                        scrollTimeout = setTimeout(function() {
                            header.classList.remove('hidden');
                            isScrollingDown = false;
                            scrollTimeout = null;
                        }, 3000);
                    }
                }

                
                lastScrollTop = getScrollTop();

                
                window.addEventListener('scroll', function() {
                    if (!ticking) {
                        window.requestAnimationFrame(function() {
                            handleScroll();
                            ticking = false;
                        });
                        ticking = true;
                    }
                }, { passive: true });

                
                handleScroll();
            }
        })();
    </script>
</body>
</html>
